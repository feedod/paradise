<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Компаньон с Live2D</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #live2d-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        #chat-container { position: relative; z-index: 2; flex: 1; display: flex; flex-direction: column; padding: 10px; }
        #messages { flex: 1; overflow-y: auto; padding: 10px; }
        .message { max-width: 80%; padding: 10px 15px; border-radius: 20px; margin: 5px 0; word-wrap: break-word; }
        .user { align-self: flex-end; background: #0088ff; color: white; }
        .bot { align-self: flex-start; background: #e5e5ea; color: black; }
        #input-container { display: flex; padding: 10px; background: rgba(255,255,255,0.9); }
        #input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; }
        #send { margin-left: 10px; padding: 10px 20px; background: #0088ff; color: white; border: none; border-radius: 20px; }
    </style>
</head>
<body>
    <canvas id="live2d-canvas"></canvas>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-container">
            <input type="text" id="input" placeholder="Напиши сообщение...">
            <button id="send">Отправить</button>
        </div>
    </div>

    <script>
        // Инициализация Telegram Web App
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        // Тема Telegram
        const theme = Telegram.WebApp.themeParams;
        document.body.style.backgroundColor = theme.bg_color || '#ffffff';

        // PIXI приложение
        const canvas = document.getElementById('live2d-canvas');
        const app = new PIXI.Application({
            view: canvas,
            transparent: true,
            resizeTo: window
        });

        let model;
        let isTalking = false;
        let mouthParamIndex = -1;

        (async () => {
            // Загрузка модели (пример бесплатной тестовой модели Shizuku — замените на свою!)
            model = await PIXI.live2d.Live2DModel.from('https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display@master/test/assets/shizuku/shizuku.model.json');

            app.stage.addChild(model);

            // Позиция и масштаб
            model.scale.set(0.35);
            model.anchor.set(0.5, 1); // нижний центр
            model.position.set(window.innerWidth / 2, window.innerHeight);

            // Перетаскивание
            model.buttonMode = true;
            model.on('pointerdown', onPointerDown);
            function onPointerDown(e) {
                model.dragging = true;
                model.dragOffset = e.data.global.clone();
                model.dragOffset.x -= model.x;
                model.dragOffset.y -= model.y;
            }
            window.addEventListener('pointermove', (e) => {
                if (model.dragging) {
                    model.x = e.clientX - model.dragOffset.x;
                    model.y = e.clientY - model.dragOffset.y;
                }
            });
            window.addEventListener('pointerup', () => { model.dragging = false; });

            // Реакция на тап
            model.on('hit', (areas) => {
                if (areas.includes('body') || areas.includes('head')) {
                    model.motion('tap');
                }
            });

            // Фоновая анимация
            model.startRandomMotion('idle');

            // Параметр рта (для большинства моделей — ParamMouthOpenY)
            mouthParamIndex = model.internalModel.coreModel.parameters.ids.indexOf('ParamMouthOpenY');

            // Анимация речи
            function animateMouth() {
                if (!isTalking) return;
                const value = Math.abs(Math.sin(Date.now() / 150)) * 0.8;
                if (mouthParamIndex !== -1) {
                    model.internalModel.coreModel.parameters.values[mouthParamIndex] = value;
                }
                requestAnimationFrame(animateMouth);
            }
        })();

        // Чат
        const messagesDiv = document.getElementById('messages');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('send');

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.textContent = text;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        sendBtn.onclick = async () => {
            const userText = input.value.trim();
            if (!userText) return;
            addMessage('user', userText);
            input.value = '';

            addMessage('bot', 'Думаю...');
            if (model) {
                isTalking = true;
                animateMouth();
            }

            try {
                // Замените YOUR_OPENAI_API_KEY на свой ключ!
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer YOUR_OPENAI_API_KEY'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini', // или gpt-3.5-turbo
                        messages: [
                            { role: 'system', content: 'Ты милый и дружелюбный аниме-компаньон. Отвечай на русском языке, будь игривой и заботливой.' },
                            { role: 'user', content: userText }
                        ],
                        temperature: 0.8
                    })
                });

                if (!response.ok) throw new Error('Ошибка API');

                const data = await response.json();
                const botText = data.choices[0].message.content.trim();

                // Заменяем "Думаю..."
                messagesDiv.lastChild.textContent = botText;

                // Голосовой синтез
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(botText);
                    utterance.lang = 'ru-RU';
                    utterance.rate = 1.0;
                    utterance.onend = () => {
                        isTalking = false;
                        if (mouthParamIndex !== -1) model.internalModel.coreModel.parameters.values[mouthParamIndex] = 0;
                    };
                    speechSynthesis.speak(utterance);
                } else {
                    isTalking = false;
                }
            } catch (err) {
                messagesDiv.lastChild.textContent = 'Ошибка: ' + err.message;
                isTalking = false;
            }
        };

        // Отправка по Enter
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendBtn.click();
        });
    </script>
</body>
</html>