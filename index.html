<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      touch-action: none;
      font-family: system-ui, -apple-system, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js" crossorigin="anonymous"></script>
</head>
<body>

  <script>
    'use strict';

    class Paradise {
      constructor() {
        this.widget = null;
        this.recognition = null;
        this.isSpeaking = false;
        this.isListening = false;

        if (!window.Telegram?.WebApp) return;

        this.init();
      }

      async init() {
        try {
          this.setupTelegram();
          await this.loadLive2DWidget();
          this.setupStt();
          this.setupCleanup();
        } catch (error) {
          console.error('Paradise initialization failed:', error);
        }
      }

      setupTelegram() {
        const { WebApp } = window.Telegram;
        WebApp.ready();
        WebApp.expand();
        WebApp.setHeaderColor('#000000');
        WebApp.setBackgroundColor('#000000');
        WebApp.disableVerticalSwipes();

        WebApp.BackButton.show();
        WebApp.BackButton.onClick(() => {
          WebApp.showConfirm('Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Paradise?', (confirmed) => {
            if (confirmed) {
              WebApp.close();
            }
          });
        });
      }

      async loadLive2DWidget() {
        try {
          L2Dwidget.init({
            model: {
              jsonPath: 'https://cdn.jsdelivr.net/npm/live2d-widget-model-haru@1.0.5/assets/haru02.model.json'
            },
            display: {
              superSample: 2,
              width: window.innerWidth,
              height: window.innerHeight,
              position: 'center',
              hOffset: 0,
              vOffset: 0
            },
            mobile: {
              show: true,
              scale: 1
            },
            react: {
              opacityDefault: 1
            }
          });
        } catch (error) {
          console.error('Live2D widget loading failed:', error);
          throw error;
        }
      }

      setupStt() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          console.warn('Speech Recognition not supported');
          return;
        }

        this.recognition = new SpeechRecognition();
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        this.recognition.lang = 'en-US';

        this.recognition.onresult = this.handleSpeechResult.bind(this);
        this.recognition.onerror = this.handleSttError.bind(this);
        this.recognition.onend = this.handleSttEnd.bind(this);

        setTimeout(() => this.startListening(), 1500);
      }

      startListening() {
        if (this.recognition && !this.isListening && !this.isSpeaking) {
          try {
            this.recognition.start();
            this.isListening = true;
          } catch (error) {
            setTimeout(() => this.startListening(), 1000);
          }
        }
      }

      stopListening() {
        if (this.recognition && this.isListening) {
          try {
            this.recognition.stop();
          } catch (error) {}
          this.isListening = false;
        }
      }

      handleSpeechResult(event) {
        const userText = Array.from(event.results)
          .map(result => result[0].transcript)
          .join('')
          .trim();
        if (userText) {
          this.processInput(userText);
        }
      }

      handleSttError(event) {
        this.isListening = false;
        if (event.error !== 'aborted') {
          setTimeout(() => this.startListening(), 1000);
        }
      }

      handleSttEnd() {
        this.isListening = false;
        if (!this.isSpeaking) {
          setTimeout(() => this.startListening(), 500);
        }
      }

      async processInput(userText) {
        this.stopListening();

        try {
          const aiResponse = this.getLocalResponse(userText);
          await this.speak(aiResponse);
        } catch (error) {
          await this.speak('ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Paradise. Ð“Ð¾Ð²Ð¾Ñ€Ð¸ ÑÐ¾ Ð¼Ð½Ð¾Ð¹ ðŸ˜Š');
        } finally {
          if (!this.isSpeaking) {
            setTimeout(() => this.startListening(), 1000);
          }
        }
      }

      getLocalResponse(userInput) {
        const lower = userInput.toLowerCase();

        if (lower.includes('Ð¿Ñ€Ð¸Ð²ÐµÑ‚') || lower.includes('hi') || lower.includes('hello')) {
          return 'ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Paradise, Ñ‚Ð²Ð¾Ñ Ð¼Ð¸Ð»Ð°Ñ ÑÐ¿ÑƒÑ‚Ð½Ð¸Ñ†Ð° ðŸ’• ÐšÐ°Ðº Ð´ÐµÐ»Ð°?';
        }
        if (lower.includes('ÐºÐ°Ðº Ð´ÐµÐ»Ð°') || lower.includes('how are you')) {
          return 'Ð£ Ð¼ÐµÐ½Ñ Ð²ÑÑ‘ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ð¾! Ð Ñƒ Ñ‚ÐµÐ±Ñ? ðŸ˜Š';
        }
        if (lower.includes('Ð¿Ð¾ÐºÐ°') || lower.includes('bye')) {
          return 'ÐŸÐ¾ÐºÐ°-Ð¿Ð¾ÐºÐ°! Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ ÑÐºÐ¾Ñ€ÐµÐµ ðŸŒ¸';
        }
        if (lower.includes('ÑÐ¿Ð°ÑÐ¸Ð±Ð¾') || lower.includes('thank')) {
          return 'Ð’ÑÐµÐ³Ð´Ð° Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°! ðŸ’–';
        }

        const responses = [
          'ÐžÐ¹, ÐºÐ°Ðº Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾! Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ ðŸ˜',
          'Ð¥Ð¸Ñ…Ð¸, Ñ‚Ñ‹ Ñ‚Ð°ÐºÐ¾Ð¹ Ð¼Ð¸Ð»Ñ‹Ð¹ ÐºÐ¾Ð³Ð´Ð° Ñ‚Ð°Ðº Ð³Ð¾Ð²Ð¾Ñ€Ð¸ÑˆÑŒ ðŸŒŸ',
          'ÐœÐ¼Ð¼, Ð¼Ð½Ðµ Ð½Ñ€Ð°Ð²Ð¸Ñ‚ÑÑ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹ Ð±Ð¾Ð»Ñ‚Ð°Ñ‚ÑŒ ðŸ’•',
          'Ð¢Ñ‹ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ð¸? Ð¯ Ð´Ð°! âœ¨',
          'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ð¼Ð½Ðµ Ñ‡Ñ‚Ð¾-Ð½Ð¸Ð±ÑƒÐ´ÑŒ Ð·Ð°Ð±Ð°Ð²Ð½Ð¾Ðµ ðŸ˜˜'
        ];

        return responses[Math.floor(Math.random() * responses.length)];
      }

      async speak(text) {
        this.isSpeaking = true;

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ru-RU'; // Ð¸Ð»Ð¸ 'en-US' ÐµÑÐ»Ð¸ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹
        utterance.volume = 0.9;
        utterance.rate = 1.0;
        utterance.pitch = 1.4;

        utterance.onend = () => {
          this.isSpeaking = false;
          setTimeout(() => this.startListening(), 500);
        };

        utterance.onerror = () => {
          this.isSpeaking = false;
          setTimeout(() => this.startListening(), 500);
        };

        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      }

      setupCleanup() {
        window.addEventListener('beforeunload', () => {
          this.stopListening();
          window.speechSynthesis.cancel();
        });
      }
    }

    new Paradise();
  </script>
</body>
</html>