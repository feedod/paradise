<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- Telegram WebApp: отключение зума, масштабирования и выделения -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Полностью отключаем выделение текста и контекстное меню -->
    <style>
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            touch-action: pan-x pan-y pinch-zoom; /* Разрешаем только нужные жесты */
        }
    </style>
    <!-- Telegram Web App SDK (latest as of 2025) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<script type="module">
    // Импортируем библиотеки с актуальных CDN (по состоянию на декабрь 2025)
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.181.2/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.181.2/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.181.2/examples/jsm/loaders/GLTFLoader.js';
    
    // Актуальная версия @pixiv/three-vrm (3.4.4)
    import { VRM, VRMUtils, VRMLoaderPlugin } from 'https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3.4.4/dist/three-vrm.module.js';

    /**
     * Главный класс приложения для отображения 3D-вайфу модели в Telegram Web App.
     * Обеспечивает инициализацию сцены, загрузку модели, рендеринг и обработку ошибок.
     */
    class WaifuTelegramApp {
        /**
         * Конструктор: инициализирует свойства класса.
         */
        constructor() {
            this.scene = new THREE.Scene();
            this.camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
            this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false, powerPreference: 'high-performance' });
            this.clock = new THREE.Clock();
            this.currentVrm = null;
            this.mixer = null;
            this.controls = null;

            this.initializeTelegram();
            this.initializeRenderer();
            this.initializeCameraAndControls();
            this.initializeLights();
            this.loadVrmModel().catch(error => this.handleError(error));
            this.startAnimationLoop();
            this.bindEventListeners();
        }

        /**
         * Инициализация Telegram Web App с учетом специфики 2025 года.
         */
        initializeTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                const webApp = Telegram.WebApp;
                webApp.ready();
                webApp.expand();
                webApp.enableClosingConfirmation();
                webApp.setBackgroundColor('#000000');
                webApp.setHeaderColor('#000000');
                // Дополнительная настройка для иммерсивного режима
                webApp.disableVerticalSwipes();
            } else {
                console.warn('Telegram Web App SDK not loaded. Running in standalone mode.');
            }
        }

        /**
         * Инициализация рендерера с оптимальными настройками для производительности.
         */
        initializeRenderer() {
            this.renderer.setPixelRatio(window.devicePixelRatio);
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            this.renderer.outputColorSpace = THREE.SRGBColorSpace;
            this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
            this.renderer.toneMappingExposure = 1.0;
            this.renderer.shadowMap.enabled = true;
            this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(this.renderer.domElement);
        }

        /**
         * Инициализация камеры и контроллера OrbitControls с ограничениями для фокуса на модели.
         */
        initializeCameraAndControls() {
            this.camera.position.set(0, 1.4, 2.2);

            this.controls = new OrbitControls(this.camera, this.renderer.domElement);
            this.controls.enableDamping = true;
            this.controls.dampingFactor = 0.05;
            this.controls.screenSpacePanning = false;
            this.controls.minDistance = 1.2;
            this.controls.maxDistance = 4.0;
            this.controls.minPolarAngle = Math.PI * 0.35;
            this.controls.maxPolarAngle = Math.PI * 0.65;
            this.controls.target.set(0, 1.35, 0);
            this.controls.update();
        }

        /**
         * Инициализация освещения в аниме-стиле для лучшей визуализации модели.
         */
        initializeLights() {
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444488, 0.8);
            hemiLight.position.set(0, 20, 0);
            this.scene.add(hemiLight);

            const mainLight = new THREE.DirectionalLight(0xfff0ea, 1.2);
            mainLight.position.set(3, 5, 4);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 2048;
            mainLight.shadow.mapSize.height = 2048;
            this.scene.add(mainLight);

            const fillLight = new THREE.DirectionalLight(0xe0c3fc, 0.6);
            fillLight.position.set(-4, 3, -3);
            this.scene.add(fillLight);
        }

        /**
         * Асинхронная загрузка VRM-модели с обработкой прогресса и ошибок.
         * @returns {Promise<void>}
         */
        async loadVrmModel() {
            const loader = new GLTFLoader();
            loader.register(parser => new VRMLoaderPlugin(parser));

            // URL публичной VRM-модели (Female из vrm-samples, waifu-style)
            const modelUrl = 'https://raw.githubusercontent.com/madjin/vrm-samples/main/vroid/Female.vrm';

            try {
                const gltf = await loader.loadAsync(modelUrl, xhr => {
                    const progress = (xhr.loaded / xhr.total) * 100;
                    console.log(`Loading model: ${progress}%`);
                    if (window.Telegram?.WebApp) {
                        Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    }
                });

                const vrm = gltf.userData.vrm;
                if (!vrm) {
                    throw new Error('VRM data not found in loaded GLTF.');
                }

                VRMUtils.removeUnnecessaryJoints(vrm.scene);
                VRMUtils.rotateVRM0(vrm);

                this.currentVrm = vrm;
                this.scene.add(vrm.scene);

                // Центрирование модели
                const boundingBox = new THREE.Box3().setFromObject(vrm.scene);
                const center = boundingBox.getCenter(new THREE.Vector3());
                vrm.scene.position.sub(center);
                vrm.scene.position.y -= boundingBox.min.y;

                // Настройка lookAt и выражений
                if (vrm.lookAt) {
                    vrm.lookAt.target = this.camera;
                }
                if (vrm.expressionManager) {
                    vrm.expressionManager.setValue('happy', 0.4);
                }

                // Инициализация микшера анимаций, если доступны
                if (gltf.animations && gltf.animations.length > 0) {
                    this.mixer = new THREE.AnimationMixer(vrm.scene);
                    gltf.animations.forEach(clip => {
                        this.mixer.clipAction(clip).play();
                    });
                }

                if (window.Telegram?.WebApp) {
                    Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }
            } catch (error) {
                this.handleError(error);
            }
        }

        /**
         * Привязка слушателей событий (resize и т.д.).
         */
        bindEventListeners() {
            window.addEventListener('resize', () => {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        /**
         * Запуск цикла анимации с использованием requestAnimationFrame.
         */
        startAnimationLoop() {
            const animate = () => {
                requestAnimationFrame(animate);
                const deltaTime = this.clock.getDelta();

                this.controls.update();

                if (this.currentVrm) {
                    this.currentVrm.update(deltaTime);
                }

                if (this.mixer) {
                    this.mixer.update(deltaTime);
                }

                this.renderer.render(this.scene, this.camera);
            };

            animate();
        }

        /**
         * Обработчик ошибок: логирование и уведомление пользователя.
         * @param {Error} error - Объект ошибки.
         */
        handleError(error) {
            console.error('Application error:', error);
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.showAlert(`Ошибка: ${error.message}`);
                Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            } else {
                alert(`Ошибка: ${error.message}`);
            }
        }
    }

    // Запуск приложения
    new WaifuTelegramApp();
</script>
</body>
</html>