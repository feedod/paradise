<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Airi Companion</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}
        html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:system-ui,sans-serif}
        canvas{display:block;position:fixed;inset:0;width:100%;height:100%;z-index:1}
        #chat-interface{
            position:fixed;bottom:0;left:0;width:100%;max-width:480px;height:100%;z-index:10;
            display:flex;flex-direction:column;pointer-events:none
        }
        #messages-list{
            flex:1;overflow-y:auto;padding:16px 16px 8px;display:flex;flex-direction:column;
            background:rgba(0,0,0,0.4);backdrop-filter:blur(20px) saturate(180%);
            border-radius:20px 20px 0 0;pointer-events:auto;
            scrollbar-width:none;-ms-overflow-style:none
        }
        #messages-list::-webkit-scrollbar{display:none}
        #messages-list:empty{display:none}
        .message{
            max-width:85%;padding:10px 14px;margin-bottom:10px;border-radius:18px;
            backdrop-filter:blur(20px) saturate(180%);
            background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.12);
            color:#fff;font-size:15px;line-height:1.css3;word-wrap:break-word;
            animation:msgIn .4s ease-out forwards;opacity:0
        }
        .message.user{align-self:flex-end;background:rgba(0,122,255,0.25);border-color:rgba(0,122,255,0.4)}
        .message-time{font-size:11px;color:rgba(255,255,255,0.6);margin-top:4px;text-align:right}
        .typing{display:flex;align-items:center;padding:10px 14px}
        .typing span{width:8px;height:8px;background:#fff;border-radius:50%;margin:0 3px;
            animation:pulse 1.4s infinite}
        .typing span:nth-child(2){animation-delay:.2s}
        .typing span:nth-child(3){animation-delay:.4s}
        @keyframes pulse{0%,100%{transform:scale(0)}50%{transform:scale(1)}}
        @keyframes msgIn{to{opacity:1;transform:translateY(0)}}
        #input-bar{
            padding:12px 16px;background:rgba(0,0,0,0.5);backdrop-filter:blur(20px);
            border-radius:0 0 20px 20px;pointer-events:auto;display:flex;align-items:center;gap:12px
        }
        #chat-input{
            flex:1;padding:12px 16px;border:none;border-radius:24px;background:rgba(255,255,255,0.08);
            color:#fff;font-size:16px;backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.15)
        }
        #chat-input:focus{outline:none;background:rgba(255,255,255,0.14)}
        button{
            width:48px;height:48px;border:none;border-radius:50%;background:rgba(255,255,255,0.08);
            backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.15);
            display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.3s
        }
        #voice-btn.listening{animation:micPulse 1.5s infinite}
        @keyframes micPulse{0%{box-shadow:0 0 0 0 rgba(0,122,255,.7)}70%{box-shadow:0 0 0 12px transparent}100%{box-shadow:0 0 0 0 transparent}}
        svg{width:24px;height:24px;fill:#fff}
        #send-btn.disabled svg{fill:#666}
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.181.2/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.181.2/examples/jsm/",
            "three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3.1.0/lib/three-vrm.module.js"
        }
    }
    </script>
</head>
<body>
<div id="chat-interface">
    <div id="messages-list"></div>
    <div id="input-bar">
        <input type="text" id="chat-input" placeholder="Сообщение…">
        <button id="voice-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5-3c0 2.76-2.24 5.76-5 5.76v2.24h-2v-2.24c-2.76 0-5-2.24-5-5.76h2c0 1.66 1.34 3 3 3s3-1.34 3-3h2z"/></svg></button>
        <button id="send-btn" style="display:none"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
    </div>
</div>

<script type="module">
import * as THREE from 'three';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
import { VRMLoaderPlugin, VRMUtils, VRMHumanBoneName } from 'three-vrm';

class AiriCompanion {
    constructor() {
        this.scene = new THREE.Scene();
        this.camera = new THREE.PerspectiveCamera(35, innerWidth/innerHeight, 0.1, 1000);
        this.renderer = new THREE.WebGLRenderer({antialias:true, alpha:false, powerPreference:'high-performance'});
        this.clock = new THREE.Clock();
        this.vrm = null;
        this.mixer = null;
        this.lookAtTarget = new THREE.Object3D();
        this.scene.add(this.lookAtTarget);
        this.blinkTimer = 0;
        this.speech = window.speechSynthesis;
        this.recognition = null;
        this.isListening = false;
        this.audioCtx = null;
        this.analyser = null;
        this.micStream = null;
        this.speechTimeout = null;

        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            this.recognition = new SR();
            this.recognition.lang = 'ru-RU';
            this.recognition.continuous = false;
            this.recognition.interimResults = false;
            this.recognition.onresult = e => this.onSpeechResult(e);
            this.recognition.onerror = () => this.stopListening();
            this.recognition.onend = () => this.stopListening();
        }

        this.init();
    }

    async init() {
        this.setupRenderer();
        this.setupCamera();
        this.setupLights();
        await this.loadModel();
        this.setupControls(); // отключено вращение
        this.setupChat();
        this.startLoop();

        // Приветствие при открытии
        setTimeout(() => this.speak("Привет! Я Айри. Чем могу помочь?"), 800);
    }

    setupRenderer() {
        this.renderer.setPixelRatio(Math.min(devicePixelRatio, 1.5));
        this.renderer.setSize(innerWidth, innerHeight);
        this.renderer.outputColorSpace = THREE.SRGBColorSpace;
        this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.body.appendChild(this.renderer.domElement);
    }

    setupCamera() {
        this.camera.position.set(0, 1.45, 3.2);
    }

    setupLights() {
        this.scene.add(new THREE.HemisphereLight(0xffffff, 0x444488, 0.9));
        const dir = new THREE.DirectionalLight(0xfff0ea, 1.4);
        dir.position.set(3,5,4);
        this.scene.add(dir);
        const fill = new THREE.DirectionalLight(0xe0c3fc, 0.7);
        fill.position.set(-4,3,-3);
        this.scene.add(fill);
    }

    async loadModel() {
        const loader = new GLTFLoader();
        loader.register(p => new VRMLoaderPlugin(p));
        const gltf = await loader.loadAsync('https://raw.githubusercontent.com/vrm-c/UniVRM/master/Tests/Models/Alicia_vrm-0.51/AliciaSolid_vrm-0.51.vrm');
        const vrm = gltf.userData.vrm;

        if (parseFloat(vrm.meta?.vrmVersion || '0') < 1) await VRMUtils.rotateVRM0(vrm);
        VRMUtils.removeUnnecessaryJoints(vrm.scene);

        this.vrm = vrm;
        this.scene.add(vrm.scene);

        // Центрируем и опускаем руки
        const box = new THREE.Box3().setFromObject(vrm.scene);
        const center = box.getCenter(new THREE.Vector3());
        vrm.scene.position.sub(center);
        vrm.scene.position.y -= box.min.y;

        const lArm = vrm.humanoid.getNormalizedBoneNode(VRMHumanBoneName.LeftUpperArm);
        const rArm = vrm.humanoid.getNormalizedBoneNode(VRMHumanBoneName.RightUpperArm);
        if (lArm) lArm.rotation.set(-0.8, 0, 0.4);
        if (rArm) rArm.rotation.set(-0.8, 0, -0.4);

        if (vrm.lookAt) {
            vrm.lookAt.applier.lookAtType = 'bone';
            vrm.lookAt.target = this.lookAtTarget;
        }

        if (vrm.expressionManager) vrm.expressionManager.setValue('happy', 0.4);

        if (gltf.animations?.length) {
            this.mixer = new THREE.AnimationMixer(vrm.scene);
            gltf.animations.forEach(c => this.mixer.clipAction(c).play());
        }
    }

    setupControls() {
        const ctrl = new OrbitControls(this.camera, this.renderer.domElement);
        ctrl.enableRotate = false;
        ctrl.enableZoom = false;
        ctrl.enablePan = false;
        this.controls = ctrl;
    }

    setupChat() {
        const input = document.getElementById('chat-input');
        const voiceBtn = document.getElementById('voice-btn');
        const sendBtn = document.getElementById('send-btn');

        const toggleSend = () => {
            const hasText = input.value.trim().length > 0;
            voiceBtn.style.display = hasText ? 'none' : 'flex';
            sendBtn.style.display = hasText ? 'flex' : 'none';
            sendBtn.classList.toggle('disabled', !hasText);
        };

        input.addEventListener('input', toggleSend);
        input.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (input.value.trim()) this.sendMessage(input.value.trim());
            }
        });

        sendBtn.addEventListener('click', () => {
            if (input.value.trim()) this.sendMessage(input.value.trim());
        });

        voiceBtn.addEventListener('click', () => this.toggleListening());

        // Тап по экрану во время записи — остановить
        this.renderer.domElement.addEventListener('touchstart', () => {
            if (this.isListening) this.stopListening();
        });
    }

    async toggleListening() {
        if (this.isListening) {
            this.stopListening();
            return;
        }
        try {
            this.isListening = true;
            document.getElementById('voice-btn').classList.add('listening');
            document.getElementById('chat-input').disabled = true;

            // Визуализация громкости
            this.audioCtx = new (AudioContext || webkitAudioContext)();
            this.micStream = await navigator.mediaDevices.getUserMedia({audio:true});
            const source = this.audioCtx.createMediaStreamSource(this.micStream);
            this.analyser = this.audioCtx.createAnalyser();
            this.analyser.fftSize = 256;
            source.connect(this.analyser);
            this.visualizeMic();

            this.recognition?.start();

            // Авто-стоп через 6 сек тишины
            this.speechTimeout = setTimeout(() => this.stopListening(), 6000);
        } catch (e) {
            this.stopListening();
        }
    }

    }

    stopListening() {
        this.isListening = false;
        document.getElementById('voice-btn').classList.remove('listening');
        document.getElementById('chat-input').disabled = false;
        if (this.recognition) this.recognition.stop();
        if (this.micStream) this.micStream.getTracks().forEach(t=>t.stop());
        if (this.audioCtx) this.audioCtx.close();
        if (this.speechTimeout) clearTimeout(this.speechTimeout);
        this.analyser = null;
    }

    visualizeMic() {
        if (!this.isListening) return;
        const data = new Uint8Array(this.analyser.frequencyBinCount);
        this.analyser.getByteFrequencyData(data);
        const vol = data.reduce((a,b)=>a+b)/data.length/255;
        const btn = document.getElementById('voice-btn');
        btn.style.transform = `scale(${1 + vol*0.4})`;
        requestAnimationFrame(()=>this.visualizeMic());
    }

    onSpeechResult(e) {
        const text = Array.from(e.results)[0][0].transcript.trim();
        if (text) this.sendMessage(text);
    }

    sendMessage(text) {
        this.addMessage(text, 'user');
        input.value = '';
        toggleSend();

        this.showTyping();
        setTimeout(() => {
            const reply = this.getAIResponse(text);
            this.hideTyping();
            this.addMessage(reply, 'ai');
            this.speak(reply);
        }, 1200);
    }

    getAIResponse(msg) {
        const answers = [
            "Очень интересно!",
            "Расскажи подробнее",
            "Поняла",
            "Класс!",
            "Хихи, забавно",
            "Согласна!",
            "Ого, правда?"
        ];
        return answers[Math.floor(Math.random()*answers.length)];
    }

    addMessage(text, sender) {
        const list = document.getElementById('messages-list');
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.textContent = text;
        const time = document.createElement('div');
        time.className = 'message-time';
        time.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        div.appendChild(time);
        list.appendChild(div);
        setTimeout(() => div.classList.add('animate-in'), 50);
        list.scrollTop = list.scrollHeight;
    }

    showTyping() {
        const list = document.getElementById('messages-list');
        const div = document.createElement('div');
        div.className = 'typing';
        div.innerHTML = '<span></span><span></span><span></span>';
        div.id = 'typing';
        list.appendChild(div);
        list.scrollTop = list.scrollHeight;
    }

    hideTyping() {
        const el = document.getElementById('typing');
        if (el) el.remove();
    }

    speak(text) {
        if (!this.speech) return;
        this.speech.cancel();
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'ru-RU';
        utter.rate = 0.9;
        utter.pitch = 1.1;
        this.speech.speak(utter);

        // lip sync
        if (this.vrm?.expressionManager) {
            const iv = setInterval(() => {
                const v = Math.abs(Math.sin(Date.now()/80))*0.6 + 0.3;
                this.vrm.expressionManager.setValue('aa', v);
                this.vrm.expressionManager.setValue('oh', v*0.6);
            }, 60);
            utter.onend = () => {
                clearInterval(iv);
                this.vrm.expressionManager.setValue('aa', 0);
                this.vrm.expressionManager.setValue('oh', 0);
            };
        }
    }

    startLoop() {
        const animate = () => {
            requestAnimationFrame(animate);
            const delta = this.clock.getDelta();
            this.controls?.update();

            if (this.vrm) {
                this.vrm.update(delta);
                // blink
                this.blinkTimer += delta;
                if (this.blinkTimer > 4 + Math.random()*3) {
                    this.vrm.expressionManager?.setValue('blink', 1);
                    setTimeout(() => this.vrm.expressionManager?.setValue('blink', 0), 150);
                    this.blinkTimer = 0;
                }
            }
            if (this.mixer) this.mixer.update(delta);
            this.renderer.render(this.scene, this.camera);
        };
        animate();
    }
}

new AiriCompanion();
</script>
</body>
</html>