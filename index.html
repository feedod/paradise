<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      touch-action: none;
    }
    #canvas {
      width: 100%;
      height: 100%;
      touch-action: none;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "pixi.js": "https://esm.sh/pixi.js@7.4.0",
        "pixi-live2d-display": "https://esm.sh/pixi-live2d-display@0.5.0-beta",
        "annyang": "https://esm.sh/annyang@2.0.0"
      }
    }
  </script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/speak-tts@3.2.1/lib/speak-tts.min.js"></script>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script type="module">
    import { Application } from 'pixi.js';
    import { Live2DModel } from 'pixi-live2d-display';
    import annyang from 'annyang';

    (async function main() {
      'use strict';

      let model;
      let speechTts;
      let mouthAnimationInterval = null;

      try {
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
          Telegram.WebApp.setHeaderColor('#000000');
          Telegram.WebApp.setBackgroundColor('#000000');
          Telegram.WebApp.disableVerticalSwipes();
          Telegram.WebApp.enableClosingConfirmation();
        }

        const canvas = document.getElementById('canvas');
        const app = new Application({
          view: canvas,
          autoStart: true,
          backgroundColor: 0x000000,
          resizeTo: window,
          resolution: window.devicePixelRatio || 1,
          autoDensity: true,
          antialias: true,
          powerPreference: 'high-performance',
          sharedTicker: true
        });

        const live2dModelUrl = 'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json';
        model = await Live2DModel.from(live2dModelUrl, {
          autoUpdate: true
        });

        app.stage.addChild(model);
        app.stage.interactive = true;
        model.interactive = true;

        model.anchor.set(0.5);
        const updateTransform = () => {
          model.position.set(app.renderer.width / 2, app.renderer.height / 2);
          const scale = Math.min(
            (app.renderer.width * 0.9) / model.width,
            (app.renderer.height * 0.9) / model.height
          );
          model.scale.set(scale);
        };
        updateTransform();

        const resizeHandler = () => updateTransform();
        window.addEventListener('resize', resizeHandler, { passive: true });
        window.addEventListener('orientationchange', () => setTimeout(resizeHandler, 0));

        model.on('hit', (hitAreas) => {
          if (hitAreas.includes('Body')) {
            model.motion('tap_body');
            if (window.Telegram?.WebApp) {
              Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
          }
        });

        model.motion('idle');

        speechTts = new Speech();
        await speechTts.init({
          lang: 'en-us',
          volume: 0.9,
          rate: 1.1,
          pitch: 1.3,
          splitSentences: false
        });

        if (annyang) {
          annyang.setLanguage('en-US');
          annyang.addCallback('result', (userSaid) => {
            if (userSaid && userSaid.length > 0) {
              const userText = userSaid[0].trim();
              if (userText) {
                processSpeech(userText);
              }
            }
          });

          annyang.addCallback('error', (error) => {
            console.warn('Annyang error:', error);
          });

          annyang.addCallback('end', () => {
            if (!speechTts.speaking) {
              annyang.start({ continuous: true, autoRestart: true });
            }
          });

          setTimeout(() => {
            annyang.start({ continuous: true, autoRestart: true });
          }, 1000);
        } else {
          console.warn('Annyang not supported in this browser.');
        }

        const animateMouth = () => {
          if (mouthAnimationInterval) clearInterval(mouthAnimationInterval);
          mouthAnimationInterval = setInterval(() => {
            const value = Math.sin(Date.now() / 100) * 0.4 + 0.3;
            model.internalModel?.coreModel?.setParameterValueById('PARAM_MOUTH_OPEN_Y', Math.abs(value));
          }, 100);
        };

        const stopMouthAnimation = () => {
          if (mouthAnimationInterval) {
            clearInterval(mouthAnimationInterval);
            mouthAnimationInterval = null;
          }
          model.internalModel?.coreModel?.setParameterValueById('PARAM_MOUTH_OPEN_Y', 0);
        };

        const getAIResponse = async (userInput) => {
          const apiKey = 'YOUR_XAI_API_KEY_HERE';
          if (apiKey === 'YOUR_XAI_API_KEY_HERE') {
            return 'Hello! I am Airi. To use me fully, please replace the API key.';
          }
          const endpoint = 'https://api.x.ai/v1/chat/completions';

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 30000);

          const response = await fetch(endpoint, {
            method: 'POST',
            signal: controller.signal,
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              model: 'grok-4-0709',
              messages: [
                {
                  role: 'system',
                  content: 'You are Airi, a lively and unique AI companion. Keep responses concise and engaging, under 100 words.'
                },
                {
                  role: 'user',
                  content: userInput
                }
              ],
              temperature: 0.8,
              max_tokens: 150,
              stream: false
            })
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`API error: ${response.statusText}`);
          }

          const data = await response.json();
          return data.choices[0]?.message?.content?.trim() || 'Sorry, I could not process that.';
        };

        const processSpeech = async (userText) => {
          if (!userText) return;

          try {
            model.motion('tap_body');

            const aiResponse = await getAIResponse(userText);
            speechTts.speak({
              text: aiResponse,
              queue: false,
              listeners: {
                onstart: () => {
                  animateMouth();
                  model.motion('idle');
                },
                onend: () => {
                  stopMouthAnimation();
                  if (annyang && !annyang.isListening()) {
                    annyang.start({ continuous: true, autoRestart: true });
                  }
                }
              }
            });
          } catch (error) {
            console.error('AI processing error:', error);
            const fallback = 'Oops, something went wrong. Let\'s try again!';
            speechTts.speak({
              text: fallback,
              listeners: {
                onend: () => {
                  stopMouthAnimation();
                  if (annyang && !annyang.isListening()) {
                    annyang.start({ continuous: true, autoRestart: true });
                  }
                }
              }
            });
          }
        };

        setInterval(() => {
          if (!speechTts.speaking && model) {
            model.motion('idle');
          }
        }, 5000);

      } catch (error) {
        console.error('Initialization failed:', error);
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.showAlert('Failed to load Airi. Please refresh.');
        }
      }

      window.addEventListener('beforeunload', () => {
        if (annyang) {
          annyang.abort();
        }
      });
    })();
  </script>
</body>
</html>