<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      touch-action: none;
      font-family: system-ui, -apple-system, sans-serif;
    }
    #canvas {
      width: 100%;
      height: 100%;
      touch-action: none;
      display: block;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js" crossorigin="anonymous"></script>
  <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/speak-tts@3.2.1/lib/speak-tts.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <canvas id="canvas" aria-hidden="true"></canvas>

  <script type="module">
    'use strict';

    import { Application } from 'https://esm.sh/pixi.js@7.4.0?external=PIXI';
    import { Live2DModel } from 'https://esm.sh/pixi-live2d-display@0.5.0-beta';
    import annyang from 'https://esm.sh/annyang@2.0.0';

    class AiriApp {
      constructor() {
        this.model = null;
        this.speechTts = null;
        this.mouthAnimationInterval = null;
        this.conversationHistory = [];
        this.isSpeaking = false;
        this.isListening = false;

        this.init();
      }

      async init() {
        try {
          this.setupTelegram();
          const app = await this.setupPixi();
          this.model = await this.loadModel(app);
          this.setupModel(app);
          await this.setupTts();
          this.setupStt();
          this.startIdleLoop();
          this.setupCleanup();
        } catch (error) {
          console.error('Airi initialization failed:', error);
          this.showError('Failed to load Airi. Please refresh the app.');
        }
      }

      setupTelegram() {
        const { WebApp } = window.Telegram ?? {};
        if (WebApp) {
          WebApp.ready();
          WebApp.expand();
          WebApp.setHeaderColor('#000000');
          WebApp.setBackgroundColor('#000000');
          WebApp.disableVerticalSwipes();
          WebApp.enableClosingConfirmation();
        }
      }

      async setupPixi() {
        const canvas = document.getElementById('canvas');
        const app = new Application({
          view: canvas,
          autoStart: true,
          backgroundColor: 0x000000,
          resizeTo: window,
          resolution: window.devicePixelRatio || 1,
          autoDensity: true,
          antialias: true,
          powerPreference: 'high-performance',
          sharedTicker: false
        });

        window.addEventListener('resize', this.handleResize.bind(this), { passive: true });
        window.addEventListener('orientationchange', () => setTimeout(this.handleResize.bind(this), 0));

        return app;
      }

      async loadModel(app) {
        const modelUrl = 'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json';
        const model = await Live2DModel.from(modelUrl, {
          autoUpdate: true
        });

        model.alpha = 1;
        model.visible = true;
        app.stage.addChild(model);
        app.stage.interactive = true;
        model.interactive = true;

        return model;
      }

      setupModel(app) {
        this.model.anchor.set(0.5);
        this.updateTransform(app);

        this.model.on('hit', (hitAreas) => {
          if (hitAreas.includes('Body')) {
            this.model.motion('Tap', 'haru_g_m14');
            this.hapticFeedback();
          }
        });

        this.model.internalModel.motionManager.startRandomMotion('Idle');
      }

      updateTransform(app) {
        if (!this.model) return;
        this.model.position.set(app.renderer.width / 2, app.renderer.height / 2);
        const scale = Math.min(
          (app.renderer.width * 0.9) / this.model.width,
          (app.renderer.height * 0.9) / this.model.height
        );
        this.model.scale.set(scale);
      }

      handleResize() {
        if (this.app) {
          this.updateTransform(this.app);
        }
      }

      async setupTts() {
        this.speechTts = new Speech();
        await this.speechTts.init({
          lang: 'en-us',
          volume: 0.9,
          rate: 1.1,
          pitch: 1.3,
          splitSentences: false
        });
      }

      setupStt() {
        if (!annyang) {
          console.warn('Annyang not supported');
          return;
        }

        annyang.setLanguage('en-US');
        annyang.addCallback('result', this.handleSpeechResult.bind(this));
        annyang.addCallback('error', this.handleSttError.bind(this));
        annyang.addCallback('end', this.handleSttEnd.bind(this));

        setTimeout(() => {
          this.startListening();
        }, 1500);
      }

      startListening() {
        if (annyang && !this.isListening && !this.isSpeaking) {
          annyang.start({ continuous: true, autoRestart: true });
          this.isListening = true;
        }
      }

      stopListening() {
        if (annyang && this.isListening) {
          annyang.abort();
          this.isListening = false;
        }
      }

      handleSpeechResult(userSaid) {
        if (userSaid && userSaid.length > 0) {
          const userText = userSaid[0].trim();
          if (userText) {
            this.processInput(userText);
          }
        }
      }

      handleSttError(error) {
        console.warn('STT error:', error);
      }

      handleSttEnd() {
        if (!this.isSpeaking) {
          setTimeout(() => this.startListening(), 500);
        }
      }

      async processInput(userText) {
        this.stopListening();
        this.conversationHistory.push({ role: 'user', content: userText });

        try {
          this.model.motion('Tap', 'haru_g_m05');
          const aiResponse = await this.getAIResponse(userText);
          this.conversationHistory.push({ role: 'assistant', content: aiResponse });

          this.setRandomExpression();
          await this.speak(aiResponse);
        } catch (error) {
          console.error('Processing error:', error);
          this.speak('Oops, something went wrong. Let\'s try again!');
        } finally {
          if (!this.isSpeaking) {
            setTimeout(() => this.startListening(), 1000);
          }
        }
      }

      async getAIResponse(userInput) {
        const apiKey = 'YOUR_XAI_API_KEY_HERE'; // Securely replace in production
        if (apiKey === 'YOUR_XAI_API_KEY_HERE') {
          throw new Error('API key not configured');
        }

        const endpoint = 'https://api.x.ai/v1/chat/completions';
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            signal: controller.signal,
            headers: {
              'Authorization': `Bearer ${apiKey}`,
              'Content-Type': 'application/json',
              'User-Agent': 'Airi/1.0'
            },
            body: JSON.stringify({
              model: 'grok-4-0709',
              messages: [
                {
                  role: 'system',
                  content: 'You are Airi, a lively and unique AI companion with pink and blue aesthetics. Keep responses concise, fun, and under 100 words.'
                },
                ...this.conversationHistory.slice(-5) // Limit history for context
              ],
              temperature: 0.8,
              max_tokens: 150,
              stream: false
            })
          });

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`API error: ${response.status} ${response.statusText}`);
          }

          const data = await response.json();
          return data.choices[0]?.message?.content?.trim() || 'Sorry, I could not process that.';
        } catch (error) {
          if (error.name === 'AbortError') {
            throw new Error('Request timeout');
          }
          throw error;
        }
      }

      async speak(text) {
        this.isSpeaking = true;
        this.animateMouth();

        this.speechTts.speak({
          text,
          queue: false,
          listeners: {
            onstart: () => {
              this.model.internalModel.motionManager.startRandomMotion('Idle');
            },
            onend: () => {
              this.stopMouthAnimation();
              this.isSpeaking = false;
              this.setRandomExpression();
              setTimeout(() => this.startListening(), 500);
            },
            onerror: (error) => {
              console.error('TTS error:', error);
              this.stopMouthAnimation();
              this.isSpeaking = false;
              setTimeout(() => this.startListening(), 500);
            }
          }
        });
      }

      setRandomExpression() {
        const expressions = ['f00', 'f01', 'f02', 'f03', 'f04', 'f05', 'f06', 'f07'];
        const randomExpr = expressions[Math.floor(Math.random() * expressions.length)];
        this.model.expression(randomExpr);
      }

      animateMouth() {
        if (this.mouthAnimationInterval) clearInterval(this.mouthAnimationInterval);
        this.mouthAnimationInterval = setInterval(() => {
          const value = Math.abs(Math.sin(Date.now() / 150)) * 0.8;
          this.model.internalModel?.coreModel?.setParameterValueById('PARAM_MOUTH_OPEN_Y', value);
        }, 100);
      }

      stopMouthAnimation() {
        if (this.mouthAnimationInterval) {
          clearInterval(this.mouthAnimationInterval);
          this.mouthAnimationInterval = null;
        }
        this.model.internalModel?.coreModel?.setParameterValueById('PARAM_MOUTH_OPEN_Y', 0);
      }

      startIdleLoop() {
        setInterval(() => {
          if (!this.isSpeaking && !this.isListening) {
            this.model.internalModel.motionManager.startRandomMotion('Idle');
          }
        }, 8000);
      }

      hapticFeedback() {
        const { WebApp } = window.Telegram ?? {};
        if (WebApp?.HapticFeedback) {
          WebApp.HapticFeedback.impactOccurred('light');
        }
      }

      showError(message) {
        const { WebApp } = window.Telegram ?? {};
        if (WebApp?.showAlert) {
          WebApp.showAlert(message);
        } else {
          alert(message);
        }
      }

      setupCleanup() {
        window.addEventListener('beforeunload', () => {
          this.stopListening();
          if (this.speechTts) {
            this.speechTts.cancel();
          }
        });
      }
    }

    new AiriApp();
  </script>
</body>
</html>