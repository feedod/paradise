<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="utf-8">
	<title>Anime Voice TMA</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<style>
		html, body {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			background: black;
			touch-action: none;
			font-family: system-ui;
		}
	</style>

	<!-- ✅ TELEGRAM MINI APPS SDK -->
	<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>

<script type="module">
	import * as THREE from 'https://cdn.jsdelivr.net/npm/three@latest/build/three.module.js';
	import { AsciiEffect } from 'https://cdn.jsdelivr.net/npm/three@latest/examples/jsm/effects/AsciiEffect.js';

	// ==============================
	// ✅ ПОЛНАЯ ИНИЦИАЛИЗАЦИЯ TMA
	// ==============================
	const tg = window.Telegram.WebApp;

	tg.ready();          // ✅ обязательный вызов
	tg.expand();         // ✅ разворачиваем на весь экран
	tg.disableClosingConfirmation();
	tg.setBackgroundColor("#000000");
	tg.setHeaderColor("#000000");

	console.log("TMA platform:", tg.platform);
	console.log("TMA version:", tg.version);

	// ==============================
	// ✅ THREE.JS + ANIME
	// ==============================

	let camera, scene, renderer, effect;
	let head, eyeL, eyeR, mouth;
	let expression = "neutral";

	init();
	startVoiceAuto();   // ✅ СРАЗУ запускаем микрофон

	function init() {

		camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 1, 1000);
		camera.position.set(0, 40, 380);

		scene = new THREE.Scene();
		scene.background = new THREE.Color(0x000000);

		const lightMain = new THREE.PointLight(0xffffff, 2.5);
		lightMain.position.set(200, 300, 300);
		scene.add(lightMain);

		scene.add(new THREE.AmbientLight(0x404040, 1.5));

		// ===== АНИМЕ ГОЛОВА =====

		head = new THREE.Mesh(
			new THREE.SphereGeometry(150, 40, 40),
			new THREE.MeshPhongMaterial({ color: 0xffd1c1 })
		);
		scene.add(head);

		const hair = new THREE.Mesh(
			new THREE.SphereGeometry(155, 40, 40, 0, Math.PI * 2, 0, Math.PI * 0.6),
			new THREE.MeshPhongMaterial({ color: 0x151515 })
		);
		hair.position.y = 40;
		scene.add(hair);

		eyeL = new THREE.Mesh(
			new THREE.SphereGeometry(26, 20, 20),
			new THREE.MeshPhongMaterial({ color: 0x000000 })
		);
		eyeL.position.set(-48, 28, 120);
		scene.add(eyeL);

		eyeR = eyeL.clone();
		eyeR.position.x = 48;
		scene.add(eyeR);

		mouth = new THREE.Mesh(
			new THREE.TorusGeometry(22, 5, 16, 50, Math.PI),
			new THREE.MeshPhongMaterial({ color: 0xcc2244 })
		);
		mouth.position.set(0, -46, 120);
		mouth.rotation.x = Math.PI;
		scene.add(mouth);

		renderer = new THREE.WebGLRenderer({ powerPreference: "high-performance" });
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

		effect = new AsciiEffect(renderer, ' .:-+*=%@#', { invert: true });
		effect.setSize(window.innerWidth, window.innerHeight);
		effect.domElement.style.color = 'white';
		effect.domElement.style.backgroundColor = 'black';

		document.body.appendChild(effect.domElement);

		window.addEventListener('resize', onResize);
		requestAnimationFrame(animate);
	}

	function onResize() {
		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();
		renderer.setSize(window.innerWidth, window.innerHeight);
		effect.setSize(window.innerWidth, window.innerHeight);
	}

	// ==============================
	// ✅ ЭМОЦИИ
	// ==============================

	function setSmile() {
		expression = "smile";
		mouth.scale.x = 1.2;
		mouth.scale.y = 1;
	}

	function setNeutral() {
		expression = "neutral";
		mouth.scale.x = 1;
		mouth.scale.y = 0.6;
	}

	function animate(time) {
		const blink = Math.abs(Math.sin(time * 0.002)) * 0.6 + 0.4;
		eyeL.scale.y = blink;
		eyeR.scale.y = blink;

		if (expression === "smile") {
			mouth.rotation.z = Math.sin(time * 0.003) * 0.1;
		}

		effect.render(scene, camera);
		requestAnimationFrame(animate);
	}

	// ==============================
	// ✅ МИКРОФОН + РАСПОЗНАВАНИЕ + ОЗВУЧКА
	// ==============================

	let recognition;

	async function startVoiceAuto() {

		try {
			// ✅ Запрос разрешения СРАЗУ
			await navigator.mediaDevices.getUserMedia({ audio: true });
		} catch (e) {
			console.warn("Микрофон заблокирован системой");
			return;
		}

		const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

		if (!SpeechRecognition) {
			console.warn("Speech API не поддерживается");
			return;
		}

		recognition = new SpeechRecognition();
		recognition.lang = "ru-RU";
		recognition.continuous = true;
		recognition.interimResults = false;

		recognition.onresult = (event) => {
			const text = event.results[event.results.length - 1][0].transcript.toLowerCase();
			console.log("Голос:", text);

			if (text.includes("привет")) {
				setSmile();
				speak("Привет");
			}
		};

		recognition.onerror = () => {
			restartRecognition();
		};

		recognition.onend = () => {
			restartRecognition();
		};

		recognition.start();
	}

	function restartRecognition() {
		try {
			recognition.start();
		} catch (e) {}
	}

	function speak(text) {
		const utterance = new SpeechSynthesisUtterance(text);
		utterance.lang = "ru-RU";
		speechSynthesis.speak(utterance);
	}

</script>

</body>
</html>