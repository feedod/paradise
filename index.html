<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <style>
        body, html { 
            margin:0; padding:0; overflow:hidden; background:#000; 
            height:100vh; width:100vw; display:block; 
        }
        /* Для самых новых TWA — учитываем safe-area */
        body { padding-env(safe-area-inset-top, 0) padding-env(safe-area-inset-bottom, 0); }
    </style>
</head>
<body>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script type="module">
    'use strict';

    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js';
    import { AsciiEffect } from 'https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/effects/AsciiEffect.js';
    import { TrackballControls } from 'https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/controls/TrackballControls.js';

    // === Переменные ===
    let camera, scene, renderer, effect, controls;
    let girl;
    const startTime = Date.now();

    // Telegram Mini App готовность (без expand — мы уже внутри TWA)
    if (window.Telegram?.WebApp) {
        Telegram.WebApp.ready();
    }

    // === Инициализация ===
    function init() {
        // Камера
        camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, 1, 1000);
        camera.position.set(0, 20, 380);

        // Сцена
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);

        // Свет
        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        const pointLight = new THREE.PointLight(0xffbbff, 2.5);
        pointLight.position.set(200, 300, 400);
        scene.add(pointLight);

        // === CHIBI-ДЕВОЧКА ===
        girl = new THREE.Group();

        // Голова
        const head = new THREE.Mesh(
            new THREE.SphereGeometry(78, 32, 24),
            new THREE.MeshPhongMaterial({ color: 0xffeecc, flatShading: true })
        );
        head.position.y = 82;
        head.name = "head";
        girl.add(head);

        // Волосы
        const hair = new THREE.Mesh(
            new THREE.SphereGeometry(82, 32, 24, 0, Math.PI*2, 0, Math.PI*0.95),
            new THREE.MeshPhongMaterial({ color: 0xff3399, flatShading: true })
        );
        hair.position.y = 92;
        hair.position.z = -15;
        girl.add(hair);

        // Пучки (twin tails)
        const tailGeo = new THREE.SphereGeometry(28, 20, 18);
        const tailMat = new THREE.MeshPhongMaterial({ color: 0xff1177 });

        const tailL = new THREE.Mesh(tailGeo, tailMat);
        tailL.position.set(-62, 102, 5);
        tailL.rotation.z = 0.4;
        tailL.name = "tailL";
        girl.add(tailL);

        const tailR = tailL.clone();
        tailR.position.x = 62;
        tailR.rotation.z = -0.4;
        tailR.name = "tailR";
        girl.add(tailR);

        // Глаза
        const eyeGeo = new THREE.SphereGeometry(19, 20, 16);
        const eyeL = new THREE.Mesh(eyeGeo, new THREE.MeshPhongMaterial({ color: 0x000000 }));
        eyeL.position.set(-32, 92, 68);
        girl.add(eyeL);

        const eyeR = eyeL.clone();
        eyeR.position.x = 32;
        girl.add(eyeR);

        // Блики в глазах
        const shineGeo = new THREE.SphereGeometry(8);
        const shineL = new THREE.Mesh(shineGeo, new THREE.MeshPhongMaterial({ color: 0xffffff }));
        shineL.position.set(-37, 98, 78);
        girl.add(shineL);
        const shineR = shineL.clone();
        shineR.position.x = 27;
        girl.add(shineR);

        // Тело и юбка
        girl.add(new THREE.Mesh(
            new THREE.CylinderGeometry(38, 48, 95, 20),
            new THREE.MeshPhongMaterial({ color: 0xff99ee, flatShading: true })
        ));

        girl.add(new THREE.Mesh(
            new THREE.ConeGeometry(72, 62, 32),
            new THREE.MeshPhongMaterial({ color: 0xff66ff, flatShading: true })
        ).position.set(0, -42, 0));

        // Руки
        const armGeo = new THREE.CylinderGeometry(11, 11, 78, 12);
        const armMat = new THREE.MeshPhongMaterial({ color: 0xffeecc });

        const armL = new THREE.Mesh(armGeo, armMat);
        armL.position.set(-52, 28, 0);
        armL.rotation.z = Math.PI / 4;
        armL.name = "armL";
        girl.add(armL);

        const armR = armL.clone();
        armR.position.x = 52;
        armR.rotation.z = -Math.PI / 4;
        armR.name = "armR";
        girl.add(armR);

        scene.add(girl);

        // Рендерер
        renderer = new THREE.WebGLRenderer({ antialias: false, alpha: false });
        renderer.setPixelRatio(devicePixelRatio);
        renderer.setSize(innerWidth, innerHeight);

        // ASCII-эффект — максимально чёткий и милый
        effect = new AsciiEffect(renderer, " .,:;i1tfLCG08@#%&", {
            invert: false,
            resolution: 0.175,
            scale: 1
        });
        effect.setSize(innerWidth, innerHeight);
        effect.domElement.style.cssText = `
            color: #ff99ff;
            background: #000;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            line-height: 9.5px;
            letter-spacing: 1px;
            image-rendering: pixelated;
        `;

        document.body.appendChild(effect.domElement);

        // Управление
        controls = new TrackballControls(camera, effect.domElement);
        controls.rotateSpeed = 3.5;
        controls.minDistance = 220;
        controls.maxDistance = 650;

        // Обработка изменения размера
        window.addEventListener("resize", onResize);

        // Запуск анимации
        requestAnimationFrame(animate);
    }

    function onResize() {
        camera.aspect = innerWidth / innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
        effect.setSize(innerWidth, innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);

        const t = Date.now() - startTime;

        // Общее покачивание
        girl.rotation.y = Math.sin(t * 0.0012) * 0.22;
        girl.position.y = Math.abs(Math.sin(t * 0.0028)) * 22;

        // Пучки колышутся
        girl.getObjectByName("tailL").rotation.z = Math.sin(t * 0.004) * 0.35 + 0.4;
        girl.getObjectByName("tailR").rotation.z = -Math.sin(t * 0.004) * 0.35 - 0.4;

        // Ручки машут
        girl.getObjectByName("armL").rotation.z = Math.sin(t * 0.006) * 0.7 + 0.8;
        girl.getObjectByName("armR").rotation.z = -Math.sin(t * 0.006) * 0.7 - 0.8;

        controls.update();
        effect.render(scene, camera);
    }

    // === Старт ===
    init();
</script>
</body>
</html>