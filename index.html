<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Компаньон с Live2D</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script type="importmap">
        {
            "imports": {
                "pixi.js": "https://cdn.jsdelivr.net/npm/pixi.js@8.3.4/dist/pixi.mjs",
                "pixi-live2d-display-advanced/cubism4": "https://cdn.jsdelivr.net/npm/pixi-live2d-display-advanced@1.0.1/cubism4/index.mjs"
            }
        }
    </script>
    <style>
        body { margin: 0; overflow: hidden; height: 100vh; }
        #live2d-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    </style>
</head>
<body>
    <canvas id="live2d-canvas"></canvas>

    <script type="module">
        import { Application, Ticker } from 'pixi.js';
        import { Live2DModel, MotionPriority, configureCubism4 } from 'pixi-live2d-display-advanced/cubism4';

        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        const theme = Telegram.WebApp.themeParams;
        document.body.style.backgroundColor = theme.bg_color || '#ffffff';

        configureCubism4({ memorySizeMB: 256 });

        const canvas = document.getElementById('live2d-canvas');
        const app = new Application({
            view: canvas,
            resizeTo: window,
            transparent: true,
            resolution: window.devicePixelRatio || 1,
            autoDensity: true
        });

        window.addEventListener('resize', () => app.resize());

        let model;
        (async () => {
            model = await Live2DModel.from('https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test3/assets/hiyori/hiyori_pro_t10.model3.json');
            app.stage.addChild(model);

            model.scale.set(0.2);
            model.anchor.set(0.5, 1);
            model.position.set(app.screen.width / 2, app.screen.height);

            model.interactive = true;

            model.on('pointerdown', (e) => {
                model.dragging = true;
                model.dragOffset = e.data.getLocalPosition(model.parent);
                model.dragOffset.x = model.x - model.dragOffset.x * model.scale.x;
                model.dragOffset.y = model.y - model.dragOffset.y * model.scale.y;
            });

            app.stage.on('pointermove', (e) => {
                if (model.dragging) {
                    const pos = e.data.getLocalPosition(model.parent);
                    model.x = pos.x * model.scale.x + model.dragOffset.x;
                    model.y = pos.y * model.scale.y + model.dragOffset.y;
                } else {
                    model.focus(e.data.global.x, e.data.global.y);
                }
            });

            app.stage.on('pointerup', () => {
                model.dragging = false;
            });

            app.stage.on('pointerupoutside', () => {
                model.dragging = false;
            });

            model.on('hit', (hitAreas) => {
                if (hitAreas.includes('body')) {
                    model.motion('tap_body', 0, MotionPriority.FORCE);
                }
                if (hitAreas.includes('head')) {
                    model.expression(Math.random() > 0.5 ? 'f01' : 'f02');
                }
            });

            app.ticker.add((delta) => {
                model.update(delta * Ticker.shared.speed * 1000 / 60);
            });

            setInterval(() => {
                if (!model.motionManager.isFinished()) return;
                const group = 'idle';
                const index = Math.floor(Math.random() * model.internalModel.settings.motions[group].length);
                model.motion(group, index, MotionPriority.IDLE);
            }, 5000);

            model.masks.updateEveryFrame = false;
            model.internalModel.motionManager.reservedMotions = true;
        })();
    </script>
</body>
</html>