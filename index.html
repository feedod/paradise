<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Airi AI Analog</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }
    #canvas {
      width: 100%;
      height: 100%;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "pixi.js": "https://cdn.jsdelivr.net/npm/pixi.js@7/dist/pixi.mjs",
        "pixi-live2d-display": "https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.mjs"
      }
    }
  </script>
</head>
<body>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>

  <canvas id="canvas"></canvas>

  <script type="module">
    import { Application } from 'pixi.js';
    import { Live2DModel } from 'pixi-live2d-display';

    (async function main() {
      try {
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
          Telegram.WebApp.setHeaderColor('#000000');
          Telegram.WebApp.setBackgroundColor('#000000');
        }

        const app = new Application({
          view: document.getElementById('canvas'),
          autoStart: true,
          background: 0x000000,
          resizeTo: window,
          resolution: window.devicePixelRatio || 1,
          autoDensity: true,
          antialias: true
        });

        const modelUrl = 'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json';
        const model = await Live2DModel.from(modelUrl, { autoUpdate: true });

        app.stage.addChild(model);

        model.anchor.set(0.5, 0.5);
        model.position.set(app.renderer.width / 2, app.renderer.height / 2);
        model.scale.set(Math.min(app.renderer.width / model.width, app.renderer.height / model.height) * 0.8);

        const resizeHandler = () => {
          model.position.set(app.renderer.width / 2, app.renderer.height / 2);
          model.scale.set(Math.min(app.renderer.width / model.width, app.renderer.height / model.height) * 0.8);
        };

        window.addEventListener('resize', resizeHandler);

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speechSynthesis = window.speechSynthesis;

        if (SpeechRecognition && speechSynthesis) {
          const recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'en-US';

          let mouthAnimationInterval;

          const animateMouth = () => {
            mouthAnimationInterval = setInterval(() => {
              const value = Math.random();
              model.internalModel.coreModel.setParameterValueById('PARAM_MOUTH_OPEN_Y', value);
            }, 50);
          };

          const stopMouthAnimation = () => {
            clearInterval(mouthAnimationInterval);
            model.internalModel.coreModel.setParameterValueById('PARAM_MOUTH_OPEN_Y', 0);
          };

          const getAIResponse = async (userInput) => {
            const apiKey = 'YOUR_XAI_API_KEY_HERE'; // Replace with your xAI API key
            const endpoint = 'https://api.x.ai/v1/chat/completions';

            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'grok-4-0709',
                messages: [
                  {
                    role: 'system',
                    content: 'You are Airi, a lively and unique AI companion with a contrasting color palette of pink and blue. You are helpful, fun, and engaging in conversations.'
                  },
                  {
                    role: 'user',
                    content: userInput
                  }
                ]
              })
            });

            if (!response.ok) {
              throw new Error('API request failed');
            }

            const data = await response.json();
            return data.choices[0].message.content;
          };

          recognition.onresult = async (event) => {
            const userText = event.results[0][0].transcript.trim();
            if (userText) {
              try {
                await model.motionManager.startRandomMotion('tap_body');

                const aiResponse = await getAIResponse(userText);

                const utterance = new SpeechSynthesisUtterance(aiResponse);
                utterance.lang = 'en-US';
                utterance.volume = 1;
                utterance.rate = 1;
                utterance.pitch = 1.2; // Slightly higher pitch for lively feel

                utterance.onstart = () => {
                  animateMouth();
                  model.motionManager.startRandomMotion('idle');
                };

                utterance.onend = () => {
                  stopMouthAnimation();
                  recognition.start();
                };

                speechSynthesis.speak(utterance);
              } catch (error) {
                console.error('Error:', error);
                recognition.start();
              }
            } else {
              recognition.start();
            }
          };

          recognition.onend = () => {
            recognition.start();
          };

          recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            recognition.start();
          };

          recognition.start();
        } else {
          console.warn('Speech APIs not supported.');
        }
      } catch (error) {
        console.error('Initialization error:', error);
      }
    })();
  </script>
</body>
</html>