<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="utf-8">
	<title>Anime Voice Character TWA</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<style>
		html, body {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			background: black;
			font-family: system-ui;
		}
	</style>

	<!-- âœ… ÐžÐ¤Ð˜Ð¦Ð˜ÐÐ›Ð¬ÐÐ«Ð™ TELEGRAM WEB APP SDK -->
	<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@latest/build/three.module.js';
import { AsciiEffect } from 'https://cdn.jsdelivr.net/npm/three@latest/examples/jsm/effects/AsciiEffect.js';


// ==============================
// âœ… TELEGRAM WEB APP (TWA)
// ==============================

const tg = window.Telegram.WebApp;
tg.ready();                 // Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾
tg.disableClosingConfirmation();
tg.setBackgroundColor("#000000");
tg.setHeaderColor("#000000");

// âŒ ÐÐ• Ñ€Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð° Ð²ÐµÑÑŒ ÑÐºÑ€Ð°Ð½:
// tg.expand(); â€” ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ ÐÐ• Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼

// âœ… ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ñ„Ð¸Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð¼Ð¸ÐºÑ€Ð¾Ñ„Ð¾Ð½
tg.MainButton.setText("ðŸŽ¤ Ð’ÐšÐ›Ð®Ð§Ð˜Ð¢Ð¬ Ð“ÐžÐ›ÐžÐ¡");
tg.MainButton.show();

tg.MainButton.onClick(async () => {
	await requestMic();
	startRecognition();
	tg.MainButton.hide();
});


// ==============================
// âœ… THREE.JS Ð¡Ð¦Ð•ÐÐ
// ==============================

let camera, scene, renderer, effect;
let head, eyeL, eyeR, mouth;
let body, armL, armR, legL, legR;

let expression = "neutral";

init();
animate();

function init() {

	camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1500);
	camera.position.set(0, 120, 600);

	scene = new THREE.Scene();
	scene.background = new THREE.Color(0x000000);

	scene.add(new THREE.AmbientLight(0x404040, 1.4));

	const light = new THREE.PointLight(0xffffff, 2.5);
	light.position.set(300, 400, 300);
	scene.add(light);

	// =========================
	// âœ… ÐŸÐžÐ›ÐÐžÐ¦Ð•ÐÐÐ«Ð™ ÐŸÐ•Ð Ð¡ÐžÐÐÐ–
	// =========================

	// Ð“Ð¾Ð»Ð¾Ð²Ð°
	head = new THREE.Mesh(
		new THREE.SphereGeometry(70, 32, 32),
		new THREE.MeshPhongMaterial({ color: 0xffd1c1 })
	);
	head.position.y = 220;
	scene.add(head);

	// Ð’Ð¾Ð»Ð¾ÑÑ‹
	const hair = new THREE.Mesh(
		new THREE.SphereGeometry(74, 32, 32, 0, Math.PI * 2, 0, Math.PI * 0.6),
		new THREE.MeshPhongMaterial({ color: 0x111111 })
	);
	hair.position.y = 250;
	scene.add(hair);

	// Ð“Ð»Ð°Ð·Ð°
	eyeL = new THREE.Mesh(new THREE.SphereGeometry(10, 16, 16), new THREE.MeshPhongMaterial({ color: 0x000000 }));
	eyeR = eyeL.clone();

	eyeL.position.set(-18, 230, 55);
	eyeR.position.set(18, 230, 55);

	scene.add(eyeL, eyeR);

	// Ð Ð¾Ñ‚
	mouth = new THREE.Mesh(
		new THREE.TorusGeometry(16, 4, 16, 40, Math.PI),
		new THREE.MeshPhongMaterial({ color: 0xcc2244 })
	);
	mouth.position.set(0, 205, 58);
	mouth.rotation.x = Math.PI;
	scene.add(mouth);

	// Ð¢ÐµÐ»Ð¾
	body = new THREE.Mesh(
		new THREE.CylinderGeometry(45, 55, 140, 24),
		new THREE.MeshPhongMaterial({ color: 0x8899ff })
	);
	body.position.y = 115;
	scene.add(body);

	// Ð ÑƒÐºÐ¸
	armL = new THREE.Mesh(new THREE.CylinderGeometry(10, 12, 100, 16), body.material);
	armR = armL.clone();

	armL.position.set(-70, 120, 0);
	armR.position.set(70, 120, 0);

	scene.add(armL, armR);

	// ÐÐ¾Ð³Ð¸
	legL = new THREE.Mesh(new THREE.CylinderGeometry(14, 16, 100, 16), new THREE.MeshPhongMaterial({ color: 0x333333 }));
	legR = legL.clone();

	legL.position.set(-25, 20, 0);
	legR.position.set(25, 20, 0);

	scene.add(legL, legR);

	// =========================

	renderer = new THREE.WebGLRenderer({ powerPreference: "high-performance" });
	renderer.setSize(window.innerWidth, window.innerHeight);
	renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

	effect = new AsciiEffect(renderer, ' .:-+*=%@#', { invert: true });
	effect.setSize(window.innerWidth, window.innerHeight);
	effect.domElement.style.color = 'white';
	effect.domElement.style.backgroundColor = 'black';

	document.body.appendChild(effect.domElement);

	window.addEventListener('resize', onResize);
}

function onResize() {
	camera.aspect = window.innerWidth / window.innerHeight;
	camera.updateProjectionMatrix();
	renderer.setSize(window.innerWidth, window.innerHeight);
	effect.setSize(window.innerWidth, window.innerHeight);
}


// ==============================
// âœ… Ð­ÐœÐžÐ¦Ð˜Ð˜
// ==============================

function setSmile() {
	expression = "smile";
	mouth.scale.x = 1.3;
	mouth.scale.y = 1;
}

function setNeutral() {
	expression = "neutral";
	mouth.scale.x = 1;
	mouth.scale.y = 0.6;
}

function animate(time = 0) {
	const blink = Math.abs(Math.sin(time * 0.002)) * 0.6 + 0.4;
	eyeL.scale.y = blink;
	eyeR.scale.y = blink;

	if (expression === "smile") {
		mouth.rotation.z = Math.sin(time * 0.004) * 0.1;
	}

	effect.render(scene, camera);
	requestAnimationFrame(animate);
}


// ==============================
// âœ… Ð“ÐžÐ›ÐžÐ¡ Ð§Ð•Ð Ð•Ð— TWA
// ==============================

let recognition;

async function requestMic() {
	await navigator.mediaDevices.getUserMedia({ audio: true });
}

function startRecognition() {

	const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
	if (!SpeechRecognition) return;

	recognition = new SpeechRecognition();
	recognition.lang = "ru-RU";
	recognition.continuous = true;

	recognition.onresult = (e) => {
		const text = e.results[e.results.length - 1][0].transcript.toLowerCase();

		if (text.includes("Ð¿Ñ€Ð¸Ð²ÐµÑ‚")) {
			setSmile();
			speak("ÐŸÑ€Ð¸Ð²ÐµÑ‚");
		}
	};

	recognition.onerror = () => restart();
	recognition.onend = () => restart();

	recognition.start();
}

function restart() {
	try { recognition.start(); } catch {}
}

function speak(text) {
	const msg = new SpeechSynthesisUtterance(text);
	msg.lang = "ru-RU";
	speechSynthesis.speak(msg);
}

</script>

</body>
</html>