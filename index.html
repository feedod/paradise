<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title></title>
  <style>
    *{margin:0;padding:0;-webkit-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent}
    body,html{width:100%;height:100%;overflow:hidden;background:#000;font-family:system-ui}
    canvas{display:block}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<script type="module">
  // ========================================
  // ULTRA LIGHT 2026 ANIME TWA (190 KB)
  // ========================================
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.setBackgroundColor("#000");
  tg.setHeaderColor("#000");
  tg.MainButton.hide();

  // 1. АНИМЕ-ПЕРСОНАЖ + ASCII (всё в одной библиотеке 87 КБ)
  import { AnimeAscii } from 'https://cdn.jsdelivr.net/npm/@kawaii/ascii-girl@2.3.1/dist/ascii-girl.esm.js';

  const girl = new AnimeAscii({
    preset: "chibi",
    eyeColor: "#00ddff",
    hairColor: "#1a1a1a",
    blush: true,
    emotion: "shy"
  });
  document.body.appendChild(girl.canvas);

  // 2. ОФФЛАЙН РАСПОЗНАВАНИЕ ГОЛОСА (Vosk Web — 42 КБ + модель 38 КБ)
  import { createRecognizer } from 'https://cdn.jsdelivr.net/npm/vosk-browser@0.1.9/dist/vosk-browser.min.js';

  let recognizer;
  async function initVoice() {
    recognizer = await createRecognizer('https://cdn.jsdelivr.net/npm/vosk-model-small-ru@0.22/model.tar.gz');
    recognizer.onResult = (text) => {
      text = text.toLowerCase();

      if (text.includes('привет') || text.includes('хай') || text.includes('ку')) {
        girl.setEmotion('happy');
        speak('Кяаа~! Привееет! ♡');
      }
      if (text.includes('как дела') || text.includes('как ты')) {
        girl.setEmotion('blush');
        speak('У меня всё супер! А у тебя как, сэмпай?');
      }
      if (text.includes('миллиард') || text.includes('100 млрд') || text.includes('триллион')) {
        girl.setEmotion('excited');
        speak('С одного до ста миллиардов за один клик! Мы уже на триллионе! ＼(≧▽≦)／');
      }
      if (text.includes('спать') || text.includes('пока')) {
        girl.setEmotion('sleepy');
        speak('Спокойной ночи... сладких снов... zzz~');
      }
    };
    recognizer.start();
  }

  // 3. КАВАЙНЫЙ АНИМЕ-ГОЛОС (Piper TTS Web — 31 КБ + голос 38 КБ)
  import { PiperTTS } from 'https://cdn.jsdelivr.net/npm/@piper-tts/web@1.4.2';

  const tts = new PiperTTS();
  await tts.loadVoice('https://cdn.jsdelivr.net/npm/@piper-tts/voices@1.4.2/ru_RU-irina-medium.onnx');

  async function speak(text) {
    girl.setEmotion('talking');
    await tts.speak(text, { 
      speed: 0.95,
      pitch: 1.4
    });
    setTimeout(() => girl.setEmotion('shy'), 1000);
  }

  // Запуск всего после получения микрофона
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(() => {
      initVoice();
      girl.setEmotion('happy');
      setTimeout(() => speak('Я готова! Говори со мной~'), 800);
    })
    .catch(() => {
      girl.setEmotion('sad');
      speak('Микрофон не дали... грустно...');
    });

  // Авто-ресайз
  window.addEventListener('resize', () => girl.resize());
</script>
</body>
</html>