<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      touch-action: none;
    }
    #canvas {
      width: 100%;
      height: 100%;
      touch-action: none;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "pixi.js": "https://esm.sh/pixi.js@7.4.0",
        "pixi-live2d-display": "https://esm.sh/pixi-live2d-display@0.4.0"
      }
    }
  </script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script type="module">
    import { Application } from 'pixi.js';
    import { Live2DModel } from 'pixi-live2d-display';

    (async function main() {
      'use strict';

      try {
        if (window.Telegram?.WebApp) {
          Telegram.WebApp.ready();
          Telegram.WebApp.expand();
          Telegram.WebApp.setHeaderColor('#000000');
          Telegram.WebApp.setBackgroundColor('#000000');
          Telegram.WebApp.disableVerticalSwipes();
        }

        const app = new Application({
          view: document.getElementById('canvas'),
          autoStart: true,
          backgroundColor: 0x000000,
          resizeTo: window,
          resolution: window.devicePixelRatio || 1,
          autoDensity: true,
          antialias: true,
          powerPreference: 'high-performance'
        });

        const modelUrl = 'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json';
        const model = await Live2DModel.from(modelUrl, { autoUpdate: true });

        app.stage.addChild(model);

        model.anchor.set(0.5, 0.5);
        model.position.set(app.renderer.width / 2, app.renderer.height / 2);
        const scaleFactor = Math.min(app.renderer.width / model.width, app.renderer.height / model.height) * 0.8;
        model.scale.set(scaleFactor);

        const resizeHandler = () => {
          const newScale = Math.min(app.renderer.width / model.width, app.renderer.height / model.height) * 0.8;
          model.scale.set(newScale);
          model.position.set(app.renderer.width / 2, app.renderer.height / 2);
        };
        window.addEventListener('resize', resizeHandler, { passive: true });
        window.addEventListener('orientationchange', resizeHandler, { passive: true });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const speechSynthesis = window.speechSynthesis;

        if (SpeechRecognition && speechSynthesis) {
          const recognition = new SpeechRecognition();
          recognition.continuous = false;
          recognition.interimResults = false;
          recognition.lang = 'en-US';

          let mouthAnimationInterval;

          const animateMouth = () => {
            if (mouthAnimationInterval) clearInterval(mouthAnimationInterval);
            mouthAnimationInterval = setInterval(() => {
              const value = Math.random() * 0.8 + 0.2;
              model.internalModel.coreModel.setParameterValueById('PARAM_MOUTH_OPEN_Y', value);
            }, 50);
          };

          const stopMouthAnimation = () => {
            if (mouthAnimationInterval) {
              clearInterval(mouthAnimationInterval);
              mouthAnimationInterval = null;
            }
            model.internalModel.coreModel.setParameterValueById('PARAM_MOUTH_OPEN_Y', 0);
          };

          const getAIResponse = async (userInput) => {
            const apiKey = 'YOUR_XAI_API_KEY_HERE';
            const endpoint = 'https://api.x.ai/v1/chat/completions';

            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'grok-4-0709',
                messages: [
                  {
                    role: 'system',
                    content: 'You are Airi, a lively and unique AI companion with a contrasting color palette of pink and blue. You are helpful, fun, and engaging in conversations.'
                  },
                  {
                    role: 'user',
                    content: userInput
                  }
                ],
                temperature: 0.7,
                max_tokens: 256
              })
            });

            if (!response.ok) {
              throw new Error(`API request failed with status ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
          };

          recognition.onresult = async (event) => {
            const userText = event.results[0][0].transcript.trim();
            if (userText) {
              try {
                model.motionManager.startRandomMotion('tap_body').catch(() => {});

                const aiResponse = await getAIResponse(userText);

                const utterance = new SpeechSynthesisUtterance(aiResponse);
                utterance.lang = 'en-US';
                utterance.volume = 1;
                utterance.rate = 1;
                utterance.pitch = 1.2;

                utterance.onstart = () => {
                  animateMouth();
                  model.motionManager.startRandomMotion('idle').catch(() => {});
                };

                utterance.onend = () => {
                  stopMouthAnimation();
                  recognition.start();
                };

                utterance.onerror = (err) => {
                  console.error('Speech synthesis error:', err);
                  stopMouthAnimation();
                  recognition.start();
                };

                speechSynthesis.speak(utterance);
              } catch (error) {
                console.error('Processing error:', error);
                recognition.start();
              }
            } else {
              recognition.start();
            }
          };

          recognition.onerror = (event) => {
            console.warn('Speech recognition error:', event.error);
            if (event.error !== 'aborted') {
              recognition.start();
            }
          };

          recognition.onend = () => {
            if (!speechSynthesis.speaking) {
              recognition.start();
            }
          };

          recognition.start();
        } else {
          console.warn('Speech APIs not supported in this browser.');
        }
      } catch (error) {
        console.error('Application initialization error:', error);
      }
    })();
  </script>
</body>
</html>