<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000000;
      overflow: hidden;
      touch-action: none;
      font-family: system-ui, -apple-system, sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    #canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js" crossorigin="anonymous"></script>
  <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@6/dist/browser/pixi.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script>
    'use strict';

    class Paradise {
      constructor() {
        this.model = null;
        this.app = null;
        this.recognition = null;
        this.mouthInterval = null;
        this.isSpeaking = false;
        this.isListening = false;

        if (!window.Telegram?.WebApp) return;

        this.init();
      }

      async init() {
        try {
          this.setupTelegram();
          await this.setupPixiAndModel();
          this.setupStt();
          this.setupCleanup();
        } catch (error) {
          console.error('Initialization failed:', error);
        }
      }

      setupTelegram() {
        const { WebApp } = window.Telegram;
        WebApp.ready();
        WebApp.expand();
        WebApp.setHeaderColor('#000000');
        WebApp.setBackgroundColor('#000000');
        WebApp.disableVerticalSwipes();

        WebApp.BackButton.show();
        WebApp.BackButton.onClick(() => {
          WebApp.showConfirm('Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Paradise?', (confirmed) => {
            if (confirmed) {
              WebApp.close();
            }
          });
        });
      }

      async setupPixiAndModel() {
        const canvas = document.getElementById('canvas');

        this.app = new PIXI.Application({
          view: canvas,
          transparent: false,
          backgroundColor: 0x000000,
          resizeTo: window,
          resolution: window.devicePixelRatio || 1,
          autoDensity: true
        });

        const modelUrl = 'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json';

        this.model = await PIXI.live2d.Live2DModel.from(modelUrl);

        this.app.stage.addChild(this.model);

        this.model.scale.set(0.25);
        this.model.anchor.set(0.5, 0.5);
        this.updatePosition();

        this.model.on('hit', (hitAreas) => {
          if (hitAreas.length > 0) {
            this.model.motion('Tap');
            if (window.Telegram?.WebApp?.HapticFeedback) {
              window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
            }
          }
        });

        this.model.motion('Idle');

        window.addEventListener('resize', () => this.updatePosition());
      }

      updatePosition() {
        if (this.model && this.app) {
          this.model.position.set(this.app.screen.width / 2, this.app.screen.height / 2);

          const scale = Math.min(this.app.screen.width / this.model.width, this.app.screen.height / this.model.height) * 0.9;
          this.model.scale.set(scale);
        }
      }

      setupStt() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return;

        this.recognition = new SpeechRecognition();
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        this.recognition.lang = 'ru-RU';

        this.recognition.onresult = this.handleSpeechResult.bind(this);
        this.recognition.onerror = this.handleSttError.bind(this);
        this.recognition.onend = this.handleSttEnd.bind(this);

        setTimeout(() => this.startListening(), 2000);
      }

      startListening() {
        if (this.recognition && !this.isListening && !this.isSpeaking) {
          try {
            this.recognition.start();
            this.isListening = true;
          } catch (e) {
            setTimeout(() => this.startListening(), 1000);
          }
        }
      }

      stopListening() {
        if (this.recognition && this.isListening) {
          try {
            this.recognition.abort();
          } catch (e) {}
          this.isListening = false;
        }
      }

      handleSpeechResult(event) {
        const transcript = event.results[0][0].transcript.trim();
        if (transcript) {
          this.processInput(transcript);
        }
      }

      handleSttError() {
        this.isListening = false;
        setTimeout(() => this.startListening(), 1000);
      }

      handleSttEnd() {
        this.isListening = false;
        if (!this.isSpeaking) {
          setTimeout(() => this.startListening(), 500);
        }
      }

      async processInput(text) {
        this.stopListening();

        const response = this.getLocalResponse(text);

        this.model.motion('Tap');
        this.model.expression();

        await this.speak(response);

        this.model.motion('Idle');
      }

      getLocalResponse(input) {
        const lower = input.toLowerCase();

        if (lower.includes('Ð¿Ñ€Ð¸Ð²ÐµÑ‚') || lower.includes('hi')) return 'ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð¯ Paradise ðŸ’• Ð Ð°Ð´Ð° Ñ‚ÐµÐ±Ñ ÑÐ»Ñ‹ÑˆÐ°Ñ‚ÑŒ!';
        if (lower.includes('ÐºÐ°Ðº Ð´ÐµÐ»Ð°')) return 'Ð’ÑÑ‘ ÑÑƒÐ¿ÐµÑ€! Ð Ñƒ Ñ‚ÐµÐ±Ñ ÐºÐ°Ðº? ðŸ˜Š';
        if (lower.includes('Ð¿Ð¾ÐºÐ°')) return 'ÐŸÐ¾ÐºÐ°! ÐŸÑ€Ð¸Ñ…Ð¾Ð´Ð¸ ÐµÑ‰Ñ‘ ðŸŒ¸';

        const replies = [
          'Ð Ð°ÑÑÐºÐ°Ð¶Ð¸ Ñ‡Ñ‚Ð¾-Ð½Ð¸Ð±ÑƒÐ´ÑŒ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾Ðµ! ðŸ˜',
          'Ð¢Ñ‹ Ñ‚Ð°ÐºÐ¾Ð¹ Ð¼Ð¸Ð»Ñ‹Ð¹ ðŸ’–',
          'Ð¥Ð¸Ñ…Ð¸, Ð¼Ð½Ðµ Ð½Ñ€Ð°Ð²Ð¸Ñ‚ÑÑ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ âœ¨',
          'Ð§Ñ‚Ð¾ Ð½Ð¾Ð²ÐµÐ½ÑŒÐºÐ¾Ð³Ð¾? ðŸ˜˜',
          'Ð¯ Ð·Ð´ÐµÑÑŒ, Ð³Ð¾Ð²Ð¾Ñ€Ð¸ ÑÐ¾ Ð¼Ð½Ð¾Ð¹! ðŸ’•'
        ];

        return replies[Math.floor(Math.random() * replies.length)];
      }

      async speak(text) {
        this.isSpeaking = true;
        this.startMouthAnimation();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ru-RU';
        utterance.rate = 1.0;
        utterance.pitch = 1.4;
        utterance.volume = 0.9;

        utterance.onend = () => {
          this.stopMouthAnimation();
          this.isSpeaking = false;
          setTimeout(() => this.startListening(), 500);
        };

        utterance.onerror = () => {
          this.stopMouthAnimation();
          this.isSpeaking = false;
          setTimeout(() => this.startListening(), 500);
        };

        speechSynthesis.cancel();
        speechSynthesis.speak(utterance);
      }

      startMouthAnimation() {
        this.stopMouthAnimation();
        this.mouthInterval = setInterval(() => {
          if (this.model?.internalModel?.coreModel) {
            const value = Math.random() * 0.8 + 0.2;
            this.model.internalModel.coreModel.setParameterValueById('PARAM_MOUTH_OPEN_Y', value);
          }
        }, 100);
      }

      stopMouthAnimation() {
        if (this.mouthInterval) clearInterval(this.mouthInterval);
        if (this.model?.internalModel?.coreModel) {
          this.model.internalModel.coreModel.setParameterValueById('PARAM_MOUTH_OPEN_Y', 0);
        }
      }

      setupCleanup() {
        window.addEventListener('beforeunload', () => {
          this.stopListening();
          speechSynthesis.cancel();
        });
      }
    }

    new Paradise();
  </script>
</body>
</html>