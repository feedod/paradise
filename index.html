<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            touch-action: manipulation;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js?64"></script>
</head>
<body>
<script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.181.2/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.181.2/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.181.2/examples/jsm/loaders/GLTFLoader.js';
    import { VRM, VRMUtils, VRMLoaderPlugin } from 'https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@3.4.4/dist/three-vrm.module.js';

    class WaifuTelegramApp {
        constructor() {
            this.scene = null;
            this.camera = null;
            this.renderer = null;
            this.clock = null;
            this.currentVrm = null;
            this.mixer = null;
            this.controls = null;

            this.init()
                .catch(error => this.handleError(error));
        }

        async init() {
            try {
                this.initializeTelegram();
                await this.initializeThreeJS();
                this.initializeCameraAndControls();
                this.initializeLights();
                await this.loadVrmModel();
                this.bindEventListeners();
                this.startAnimationLoop();
            } catch (error) {
                throw new Error(`Initialization failed: ${error.message}`);
            }
        }

        initializeTelegram() {
            if (window.Telegram?.WebApp) {
                const webApp = window.Telegram.WebApp;
                webApp.ready();
                webApp.expand();
                webApp.enableClosingConfirmation();
                webApp.setBackgroundColor('#000000');
                webApp.setHeaderColor('#000000');
                webApp.disableVerticalSwipes();
            }
        }

        initializeThreeJS() {
            return new Promise((resolve) => {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(
                    35,
                    window.innerWidth / window.innerHeight,
                    0.1,
                    100
                );

                this.renderer = new THREE.WebGLRenderer({
                    antialias: true,
                    alpha: false,
                    powerPreference: 'high-performance'
                });

                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.outputColorSpace = THREE.SRGBColorSpace;
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                this.renderer.toneMappingExposure = 1.0;
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                document.body.appendChild(this.renderer.domElement);
                this.clock = new THREE.Clock();

                resolve();
            });
        }

        initializeCameraAndControls() {
            this.camera.position.set(0, 1.4, 2.2);

            this.controls = new OrbitControls(this.camera, this.renderer.domElement);
            this.controls.enableDamping = true;
            this.controls.dampingFactor = 0.05;
            this.controls.screenSpacePanning = false;
            this.controls.minDistance = 1.2;
            this.controls.maxDistance = 4.0;
            this.controls.minPolarAngle = Math.PI * 0.35;
            this.controls.maxPolarAngle = Math.PI * 0.65;
            this.controls.target.set(0, 1.35, 0);
            this.controls.update();
        }

        initializeLights() {
            const hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x444488, 0.8);
            hemisphereLight.position.set(0, 20, 0);
            this.scene.add(hemisphereLight);

            const directionalLightMain = new THREE.DirectionalLight(0xfff0ea, 1.2);
            directionalLightMain.position.set(3, 5, 4);
            directionalLightMain.castShadow = true;
            directionalLightMain.shadow.mapSize.width = 2048;
            directionalLightMain.shadow.mapSize.height = 2048;
            this.scene.add(directionalLightMain);

            const directionalLightFill = new THREE.DirectionalLight(0xe0c3fc, 0.6);
            directionalLightFill.position.set(-4, 3, -3);
            this.scene.add(directionalLightFill);
        }

        async loadVrmModel() {
            const loader = new GLTFLoader();
            loader.register(parser => new VRMLoaderPlugin(parser));

            // Обновлённая ссылка на модель
            const modelUrl = 'https://github.com/mrxz/vrm-sample-models/raw/refs/heads/master/human_male/human_male.vrm';

            try {
                const gltf = await new Promise((resolve, reject) => {
                    loader.load(modelUrl, resolve, undefined, reject);
                });

                const vrm = gltf.userData.vrm;
                if (!vrm) {
                    throw new Error('VRM data not found in loaded GLTF');
                }

                VRMUtils.removeUnnecessaryJoints(vrm.scene);
                VRMUtils.rotateVRM0(vrm);

                this.currentVrm = vrm;
                this.scene.add(vrm.scene);

                this.centerModel(vrm.scene);

                if (vrm.lookAt) {
                    vrm.lookAt.target = this.camera;
                }

                if (vrm.expressionManager) {
                    vrm.expressionManager.setValue('happy', 0.4);
                }

                if (gltf.animations?.length > 0) {
                    this.mixer = new THREE.AnimationMixer(vrm.scene);
                    gltf.animations.forEach(clip => {
                        this.mixer.clipAction(clip).play();
                    });
                }

                if (window.Telegram?.WebApp) {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                }

            } catch (error) {
                throw new Error(`Model loading failed: ${error.message}`);
            }
        }

        centerModel(modelScene) {
            const boundingBox = new THREE.Box3().setFromObject(modelScene);
            const center = boundingBox.getCenter(new THREE.Vector3());
            modelScene.position.sub(center);
            modelScene.position.y -= boundingBox.min.y;
        }

        bindEventListeners() {
            const handleResize = () => {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            };

            window.addEventListener('resize', handleResize, { passive: true });
        }

        startAnimationLoop() {
            const animate = () => {
                requestAnimationFrame(animate);
                
                const deltaTime = this.clock.getDelta();

                if (this.controls) {
                    this.controls.update();
                }

                if (this.currentVrm) {
                    this.currentVrm.update(deltaTime);
                }

                if (this.mixer) {
                    this.mixer.update(deltaTime);
                }

                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            };

            animate();
        }

        handleError(error) {
            console.error('Application error:', error);
            
            if (window.Telegram?.WebApp) {
                window.Telegram.WebApp.showAlert(`Ошибка: ${error.message}`);
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
            }
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            new WaifuTelegramApp();
        });
    } else {
        new WaifuTelegramApp();
    }
</script>
</body>
</html>