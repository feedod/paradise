<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Paradise</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      touch-action: none;
      font-family: system-ui, -apple-system, sans-serif;
    }
    #canvas {
      width: 100%;
      height: 100%;
      touch-action: none;
      display: block;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js" crossorigin="anonymous"></script>
  <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js" crossorigin="anonymous"></script>
  <script src="https://js.puter.com/v2/"></script>
</head>
<body>
  <canvas id="canvas" aria-hidden="true"></canvas>

  <script type="module">
    'use strict';

    import { Application } from 'https://esm.sh/pixi.js@7.4.0';
    import { Live2DModel } from 'https://esm.sh/pixi-live2d-display@0.4.0';

    class Paradise {
      constructor() {
        this.model = null;
        this.recognition = null;
        this.mouthAnimationInterval = null;
        this.conversationHistory = [];
        this.isSpeaking = false;
        this.isListening = false;
        this.app = null;

        this.init();
      }

      async init() {
        try {
          this.setupTelegram();
          this.app = await this.setupPixi();
          this.model = await this.loadModel();
          this.setupModel();
          this.setupStt();
          this.startIdleLoop();
          this.setupCleanup();
        } catch (error) {
          console.error('Paradise initialization failed:', error);
          this.showError('Failed to load Paradise. Please refresh the app.');
        }
      }

      setupTelegram() {
        const { WebApp } = window.Telegram ?? {};
        if (WebApp) {
          WebApp.ready();
          WebApp.expand();
          WebApp.setHeaderColor('#000000');
          WebApp.setBackgroundColor('#000000');
          WebApp.disableVerticalSwipes();
          WebApp.enableClosingConfirmation();
        }
      }

      async setupPixi() {
        const canvas = document.getElementById('canvas');
        const app = new Application({
          view: canvas,
          autoStart: true,
          backgroundColor: 0x000000,
          resizeTo: window,
          resolution: window.devicePixelRatio || 1,
          autoDensity: true,
          antialias: true,
          powerPreference: 'high-performance',
          sharedTicker: false
        });

        window.addEventListener('resize', this.handleResize.bind(this), { passive: true });
        window.addEventListener('orientationchange', () => setTimeout(this.handleResize.bind(this), 0));

        return app;
      }

      async loadModel() {
        const modelUrl = 'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json';
        const model = await Live2DModel.from(modelUrl, {
          autoUpdate: true
        });

        model.alpha = 1;
        model.visible = true;
        this.app.stage.addChild(model);
        this.app.stage.interactive = true;
        model.interactive = true;

        console.log('Model loaded and added to stage');

        return model;
      }

      setupModel() {
        this.model.anchor.set(0.5);
        this.updateTransform();

        this.model.on('hit', (hitAreas) => {
          if (hitAreas.includes('Body')) {
            this.model.internalModel.motionManager.startRandomMotion('tap_body');
            this.hapticFeedback();
          }
        });

        this.model.internalModel.motionManager.startRandomMotion('idle');
      }

      updateTransform() {
        if (!this.model || !this.app) return;
        this.model.position.set(this.app.renderer.width / 2, this.app.renderer.height / 2);
        const scale = Math.min(
          (this.app.renderer.width * 0.9) / this.model.width,
          (this.app.renderer.height * 0.9) / this.model.height
        );
        this.model.scale.set(scale);
      }

      handleResize() {
        this.updateTransform();
      }

      setupStt() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
          console.warn('Speech Recognition not supported');
          return;
        }

        this.recognition = new SpeechRecognition();
        this.recognition.continuous = false;
        this.recognition.interimResults = false;
        this.recognition.lang = 'en-US';

        this.recognition.onresult = this.handleSpeechResult.bind(this);
        this.recognition.onerror = this.handleSttError.bind(this);
        this.recognition.onend = this.handleSttEnd.bind(this);

        setTimeout(() => {
          this.startListening();
        }, 1500);
      }

      startListening() {
        if (this.recognition && !this.isListening && !this.isSpeaking) {
          this.recognition.start();
          this.isListening = true;
        }
      }

      stopListening() {
        if (this.recognition && this.isListening) {
          this.recognition.stop();
          this.isListening = false;
        }
      }

      handleSpeechResult(event) {
        const userText = event.results[0][0].transcript.trim();
        if (userText) {
          this.processInput(userText);
        }
      }

      handleSttError(event) {
        console.warn('STT error:', event.error);
        this.isListening = false;
      }

      handleSttEnd() {
        this.isListening = false;
        if (!this.isSpeaking) {
          setTimeout(() => this.startListening(), 500);
        }
      }

      async processInput(userText) {
        this.stopListening();
        this.conversationHistory.push({ role: 'user', content: userText });

        try {
          this.model.internalModel.motionManager.startRandomMotion('tap_body');

          const aiResponse = await this.getAIResponse(userText);
          this.conversationHistory.push({ role: 'assistant', content: aiResponse });

          this.setRandomExpression();
          await this.speak(aiResponse);
        } catch (error) {
          console.error('Processing error:', error);
          this.speak('Oops, something went wrong. Let\'s try again!');
        } finally {
          if (!this.isSpeaking) {
            setTimeout(() => this.startListening(), 1000);
          }
        }
      }

      async getAIResponse(userInput) {
        if (typeof puter === 'undefined' || !puter.ai) {
          throw new Error('Puter.js not loaded');
        }

        const systemPrompt = 'You are Paradise, a lively and unique AI companion with pink and blue aesthetics. Keep responses concise, fun, and under 100 words.';
        const messages = [
          { role: 'system', content: systemPrompt },
          ...this.conversationHistory.slice(-5)
        ];

        const response = await puter.ai.chat(messages, {
          model: 'gpt-5-nano',
          temperature: 0.8,
          max_tokens: 150
        });

        return response.message.content.trim() || 'Sorry, I could not process that.';
      }

      async speak(text) {
        this.isSpeaking = true;
        this.animateMouth();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US';
        utterance.volume = 0.9;
        utterance.rate = 1.1;
        utterance.pitch = 1.3;

        utterance.onstart = () => {
          this.model.internalModel.motionManager.startRandomMotion('idle');
        };

        utterance.onend = () => {
          this.stopMouthAnimation();
          this.isSpeaking = false;
          this.setRandomExpression();
          setTimeout(() => this.startListening(), 500);
        };

        utterance.onerror = (error) => {
          console.error('TTS error:', error);
          this.stopMouthAnimation();
          this.isSpeaking = false;
          setTimeout(() => this.startListening(), 500);
        };

        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
      }

      setRandomExpression() {
        if (!this.model) return;
        const expressions = ['f00', 'f01', 'f02', 'f03', 'f04', 'f05', 'f06', 'f07'];
        const randomExpr = expressions[Math.floor(Math.random() * expressions.length)];
        this.model.expression(randomExpr);
      }

      animateMouth() {
        if (this.mouthAnimationInterval) clearInterval(this.mouthAnimationInterval);
        this.mouthAnimationInterval = setInterval(() => {
          const value = Math.abs(Math.sin(Date.now() / 150)) * 0.8;
          this.model.internalModel?.coreModel?.setParameterValueById('PARAM_MOUTH_OPEN_Y', value);
        }, 100);
      }

      stopMouthAnimation() {
        if (this.mouthAnimationInterval) {
          clearInterval(this.mouthAnimationInterval);
          this.mouthAnimationInterval = null;
        }
        this.model.internalModel?.coreModel?.setParameterValueById('PARAM_MOUTH_OPEN_Y', 0);
      }

      startIdleLoop() {
        setInterval(() => {
          if (!this.isSpeaking && !this.isListening && this.model) {
            this.model.internalModel.motionManager.startRandomMotion('idle');
          }
        }, 8000);
      }

      hapticFeedback() {
        const { WebApp } = window.Telegram ?? {};
        if (WebApp?.HapticFeedback) {
          WebApp.HapticFeedback.impactOccurred('light');
        }
      }

      showError(message) {
        const { WebApp } = window.Telegram ?? {};
        if (WebApp?.showAlert) {
          WebApp.showAlert(message);
        } else {
          alert(message);
        }
      }

      setupCleanup() {
        window.addEventListener('beforeunload', () => {
          this.stopListening();
          window.speechSynthesis.cancel();
        });
      }
    }

    new Paradise();
  </script>
</body>
</html>