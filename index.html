<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"
  >

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      background: #000;
      overflow: hidden;
    }
  </style>
</head>

<body>

<a-scene
  id="scene"
  embedded
  background="color:#000"
>

  <a-entity id="rig" position="0 1.6 2.6">
    <a-camera
      id="camera"
      fov="45"
      look-controls="enabled:false"
    ></a-camera>
  </a-entity>

  <a-light type="ambient" intensity="0.35"></a-light>
  <a-light type="directional" position="0 2 2" intensity="1.1"></a-light>
  <a-light type="point" position="0 1 -1.5" intensity="1.3" color="#5fdcff"></a-light>

  <a-entity
    id="avatar"
    gltf-model="https://models.readyplayer.me/approachable-giraffe-2a6810a2-2061-4e61-bcb2-8df02a6a13bb.glb"
    position="0 0 -1.2"
    rotation="0 180 0"
    scale="1 1 1"
  ></a-entity>

</a-scene>

<script>
Telegram.WebApp.expand()

const sceneEl  = document.getElementById("scene")
const avatarEl = document.getElementById("avatar")
const cameraEl = document.getElementById("camera")

sceneEl.addEventListener("loaded", () => {

  AFRAME.registerComponent("paradise", {
    init() {
      this.timeMs = 0
      this.isSpeaking = false

      this.blinkValue = 0
      this.blinkTarget = 0
      this.nextBlinkMs = this.randomBlinkDelay()
    },

    tick(_, deltaMs) {
      this.timeMs += deltaMs
      this.updateBlink(deltaMs)
      this.updateBody()
      this.updateGaze()
    },

    randomBlinkDelay() {
      return 2500 + Math.random() * 5000
    },

    updateBlink(deltaMs) {
      this.nextBlinkMs -= deltaMs

      if (this.nextBlinkMs <= 0) {
        this.blinkTarget = 1
        this.nextBlinkMs = this.randomBlinkDelay()
      }

      this.blinkValue += (this.blinkTarget - this.blinkValue) * 0.2

      if (this.blinkValue > 0.9) {
        this.blinkTarget = 0
      }
    },

    updateBody() {
      const breath =
        1 + Math.sin(this.timeMs / 900) * 0.014

      const idleYaw =
        Math.sin(this.timeMs / 3200) * 2

      const talkPitch =
        this.isSpeaking
          ? Math.sin(this.timeMs / 120) * 2
          : 0

      const blinkScale =
        1 - this.blinkValue * 0.12

      this.el.setAttribute("scale", {
        x: breath,
        y: breath * blinkScale,
        z: breath
      })

      this.el.setAttribute("rotation", {
        x: talkPitch,
        y: 180 + idleYaw,
        z: 0
      })
    },

    updateGaze() {
      const cam = cameraEl.object3D.position
      const obj = this.el.object3D.position

      const dx = cam.x - obj.x
      const dy = cam.y - obj.y
      const dz = cam.z - obj.z

      const yaw =
        Math.atan2(dx, dz) * 180 / Math.PI

      const pitch =
        -Math.atan2(dy, Math.sqrt(dx * dx + dz * dz)) * 180 / Math.PI

      this.el.setAttribute("rotation", {
        x: pitch,
        y: yaw + 180,
        z: 0
      })
    }
  })

  avatarEl.setAttribute("paradise", "")

  function speak(text) {
    if (!("speechSynthesis" in window)) return

    const utterance = new SpeechSynthesisUtterance(text)
    utterance.lang = "ru-RU"
    utterance.rate = 0.95
    utterance.pitch = 1.05

    utterance.onstart = () => {
      avatarEl.components.paradise.isSpeaking = true
    }

    utterance.onend = () => {
      avatarEl.components.paradise.isSpeaking = false
    }

    speechSynthesis.cancel()
    speechSynthesis.speak(utterance)
  }

  const PHRASES = [
    "Добро пожаловать.",
    "Здесь спокойно.",
    "Paradise — это состояние.",
    "Можно просто быть.",
    "Я рядом."
  ]

  setInterval(() => {
    speak(PHRASES[Math.floor(Math.random() * PHRASES.length)])
  }, 15000)

})
</script>

</body>
</html>